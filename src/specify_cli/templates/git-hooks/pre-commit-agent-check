#!/usr/bin/env bash
# Pre-commit hook to prevent committing agent directories
#
# Agent directories (.claude/, .codex/, etc.) may contain:
# - Authentication tokens and API keys
# - User-specific credentials (auth.json)
# - Session data and conversation history
#
# These should NEVER be committed to version control.

AGENT_DIRS=(".claude" ".codex" ".gemini" ".cursor" ".qwen" ".opencode"
            ".windsurf" ".kilocode" ".augment" ".roo" ".amazonq" ".github/copilot")

# Allow .claude/skills/ (project-specific Claude Code skills are safe to commit)
STAGED_AGENT_FILES=$(git diff --cached --name-only --diff-filter=ACM |
                      grep -E "^\.(claude|codex|gemini|cursor|qwen|opencode|windsurf|kilocode|augment|roo|amazonq)/|^\.github/copilot/" |
                      grep -v "^\.claude/skills/" || true)

if [ -n "$STAGED_AGENT_FILES" ]; then
    echo "❌ COMMIT BLOCKED: Agent directory files detected"
    echo ""
    echo "The following agent directory files are staged:"
    echo "$STAGED_AGENT_FILES" | sed 's/^/  /'
    echo ""
    echo "These directories should NEVER be committed:"
    for dir in "${AGENT_DIRS[@]}"; do
        echo "  - $dir/ (may contain auth tokens and credentials)"
    done
    echo ""
    echo "To fix:"
    echo "  1. Unstage these files: git reset HEAD <file>"
    echo "  2. Ensure .gitignore includes all agent directories"
    echo "  3. Run: git status to verify"
    echo ""
    echo "To bypass this check (NOT recommended): git commit --no-verify"
    exit 1
fi

# WP worktree branches must never commit planning artifacts.
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if echo "$CURRENT_BRANCH" | grep -Eq -- '-WP[0-9]+$'; then
    STAGED_KITTY_SPECS=$(git diff --cached --name-only | grep -E '^kitty-specs/' || true)

    if [ -n "$STAGED_KITTY_SPECS" ]; then
        echo "❌ COMMIT BLOCKED: WP branches must not commit kitty-specs/"
        echo ""
        echo "Branch: $CURRENT_BRANCH"
        echo "Staged planning files:"
        echo "$STAGED_KITTY_SPECS" | sed 's/^/  /'
        echo ""
        echo "To fix:"
        echo "  1. Unstage planning files: git restore --staged kitty-specs/"
        echo "  2. Keep commits limited to deliverable paths (src/, docs/, tests/, etc.)"
        echo ""
        echo "To bypass this check (NOT recommended): git commit --no-verify"
        exit 1
    fi
fi

exit 0
