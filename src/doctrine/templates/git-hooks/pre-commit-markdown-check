#!/usr/bin/env bash
#
# Pre-commit hook to validate markdown style on staged files.
#
# Uses markdownlint-cli2 and repository configuration in
# .markdownlint-cli2.jsonc.

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Integration tests run in offline-isolated environments where node tools
# are intentionally unavailable.
if [ "${SPEC_KITTY_TEST_MODE:-}" = "1" ]; then
    exit 0
fi

if ! command -v npx >/dev/null 2>&1; then
    echo -e "${RED}❌ Commit blocked: npx is required for markdown style checks.${NC}"
    echo "Install Node.js (includes npx) to enable deterministic markdown linting."
    exit 1
fi

mapfile -d '' STAGED_MD_FILES < <(git diff --cached --name-only -z --diff-filter=ACM -- '*.md' '*.mdx')

if [ "${#STAGED_MD_FILES[@]}" -eq 0 ]; then
    exit 0
fi

echo "Checking markdown style for staged files..."

if ! npx --no-install markdownlint-cli2 --config .markdownlint-cli2.jsonc "${STAGED_MD_FILES[@]}"; then
    echo ""
    echo -e "${RED}❌ Commit blocked: Markdown style violations detected${NC}"
    echo ""
    echo -e "${YELLOW}Fix options:${NC}"
    echo "  1. Edit the reported markdown files and resolve violations"
    echo "  2. Re-stage files: git add <files>"
    echo "  3. Commit again"
    echo "  4. If tooling is missing, install local dev dependencies (for example: npm install)"
    echo ""
    echo -e "${YELLOW}Bypass (not recommended):${NC} git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}✓ Markdown style checks passed${NC}"
exit 0
