#!/usr/bin/env bash
# pre-commit: lint and format-check only the Python files staged for commit.
set -euo pipefail

# Collect staged .py files (Added, Copied, Modified, Renamed)
mapfile -t STAGED_PY < <(git diff --cached --name-only --diff-filter=ACMR -- '*.py')

if [ "${#STAGED_PY[@]}" -eq 0 ]; then
  exit 0
fi

echo "pre-commit: ruff format --check on ${#STAGED_PY[@]} staged file(s)..."
python -m ruff format --check "${STAGED_PY[@]}"

echo "pre-commit: ruff check on ${#STAGED_PY[@]} staged file(s)..."
python -m ruff check "${STAGED_PY[@]}"

# Run mypy only if staged files touch src/ (skip with SKIP_MYPY=1)
if [ "${SKIP_MYPY:-}" != "1" ]; then
  SRC_FILES=()
  for f in "${STAGED_PY[@]}"; do
    case "$f" in src/*) SRC_FILES+=("$f") ;; esac
  done

  if [ "${#SRC_FILES[@]}" -gt 0 ]; then
    echo "pre-commit: mypy on ${#SRC_FILES[@]} staged src file(s)..."
    python -m mypy --strict "${SRC_FILES[@]}"
  fi
else
  echo "pre-commit: mypy skipped (SKIP_MYPY=1)"
fi
