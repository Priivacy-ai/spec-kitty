# Work Packages: Telemetry Foundation and Cost Tracking

**Inputs**: Design documents from `kitty-specs/043-telemetry-foundation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit and integration tests included per constitution requirement (90%+ coverage for new code).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Source**: `src/specify_cli/telemetry/`
- **Tests**: `tests/specify_cli/telemetry/`
- **Orchestrator**: `src/specify_cli/orchestrator/`
- **CLI**: `src/specify_cli/cli/commands/agent/`

---

## Work Package WP01: SimpleJsonStore — File-Backed EventStore (Priority: P0)

**Goal**: Implement `SimpleJsonStore` as a JSONL-backed implementation of the `spec_kitty_events.EventStore` ABC, completing the missing file persistence layer for the vendored events library.
**Independent Test**: Create a store instance, save events, load by aggregate_id, verify round-trip fidelity including sort order, idempotency, and corruption tolerance.
**Prompt**: `tasks/WP01-simple-json-store.md`
**Estimated size**: ~400 lines

### Included Subtasks
- [x] T001 Create `src/specify_cli/telemetry/__init__.py` with public API exports
- [x] T002 Implement `SimpleJsonStore` in `src/specify_cli/telemetry/store.py` (EventStore ABC: `save_event`, `load_events`, `load_all_events`)
- [x] T003 Add stream-parsing for large JSONL reads (line-by-line, no full-file load)
- [x] T004 Add idempotent write semantics (dedup by `event_id` on save)
- [x] T005 Add malformed-line tolerance (skip with warning, continue parsing)
- [x] T006 Write unit tests in `tests/specify_cli/telemetry/test_store.py`

### Implementation Notes
- `SimpleJsonStore.__init__(file_path: Path)` — single JSONL file per store instance
- Write: append mode, `json.dumps(event.to_dict(), sort_keys=True) + "\n"`
- Read: stream-parse line-by-line, `Event.from_dict()` each line, sort by `(lamport_clock, node_id)`
- Idempotency: on `save_event`, scan existing event_ids (cache in memory on first load) to skip duplicates
- Corruption: wrap `json.loads()` in try/except, log warning, skip bad lines
- Tests: CRUD, dedup, corruption tolerance, empty file, 1000+ event performance

### Parallel Opportunities
- None — this is the foundation WP.

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Performance on large files**: Stream-parsing mitigates memory issues. For idempotency check, maintain an in-memory set of event_ids loaded lazily on first write.
- **Concurrent writes**: Single-process CLI, no locking needed per constitution.

---

## Work Package WP02: Query Layer (Priority: P0)

**Goal**: Implement filtered, stream-parsed queries over execution event logs — single-feature and project-wide.
**Independent Test**: Create JSONL with mixed event types and attributes, query with various filters, verify correct results.
**Prompt**: `tasks/WP02-query-layer.md`
**Estimated size**: ~300 lines

### Included Subtasks
- [x] T007 Create `EventFilter` dataclass in `src/specify_cli/telemetry/query.py`
- [x] T008 Implement `query_execution_events(feature_dir, filters)` — filtered reads over a single feature's JSONL
- [x] T009 Implement `query_project_events(repo_root, filters)` — iterate all `kitty-specs/*/execution.events.jsonl`
- [x] T010 Write unit tests in `tests/specify_cli/telemetry/test_query.py`

### Implementation Notes
- `EventFilter` fields: `event_type`, `wp_id`, `agent`, `model`, `since`, `until`, `success` — all optional, default None
- `query_execution_events`: instantiate `SimpleJsonStore`, load events, apply filter predicates in-memory
- `query_project_events`: glob `kitty-specs/*/execution.events.jsonl`, instantiate store per file, merge results sorted by `(lamport_clock, node_id)`
- Filter matching: payload-level fields (`wp_id`, `agent`, `model`, `success`) accessed via `event.payload.get()`
- Timeframe filter: compare `event.timestamp` against `since`/`until` datetimes

### Parallel Opportunities
- T007 (dataclass) and T009 (project query) can be developed in parallel once T008 exists.

### Dependencies
- Depends on WP01 (SimpleJsonStore).

### Risks & Mitigations
- **Missing feature directories**: `query_project_events` skips missing dirs gracefully (empty result, no error).
- **Datetime parsing**: Use `datetime.fromisoformat()` (Python 3.11+ handles timezone offsets natively).

---

## Work Package WP03: Emission Pipeline and Orchestrator Integration (Priority: P0)

**Goal**: Wire execution telemetry into the orchestrator — enrich `InvocationResult`, create the emission function, and hook it into post-invocation points.
**Independent Test**: Run a mock agent invocation, verify an ExecutionEvent appears in `execution.events.jsonl` with correct fields. Verify emission failures are swallowed.
**Prompt**: `tasks/WP03-emission-pipeline.md`
**Estimated size**: ~500 lines

### Included Subtasks
- [x] T011 Create `emit_execution_event()` in `src/specify_cli/telemetry/emit.py` — constructs `spec_kitty_events.Event`, saves via `SimpleJsonStore`
- [x] T012 Wire Lamport clock into emission (`LamportClock` from `spec_kitty_events`, persist clock state)
- [x] T013 Add fire-and-forget error handling (try/except with `logger.warning`, never raises)
- [x] T014 Write unit tests for emission in `tests/specify_cli/telemetry/test_emit.py`
- [x] T015 Add optional telemetry fields to `InvocationResult` in `src/specify_cli/orchestrator/agents/base.py`
- [x] T016 [P] Add emission hook in `integration.py` after `process_wp_implementation()` completes
- [x] T017 [P] Add emission hook in `integration.py` after `process_wp_review()` completes
- [x] T018 Write integration tests for orchestrator telemetry emission in `tests/specify_cli/orchestrator/test_telemetry_integration.py`

### Implementation Notes
- `emit_execution_event()` signature: `(feature_dir, feature_slug, wp_id, agent, role, model, input_tokens, output_tokens, cost_usd, duration_ms, success, error, exit_code, node_id="cli")`
- Internally: create `LamportClock(node_id, SimpleJsonClockStorage)`, tick, build `Event(event_type="ExecutionEvent", aggregate_id=feature_slug, payload={...})`, save to store
- Clock persistence: `SimpleJsonClockStorage` stores clock value in `.kittify/telemetry-clock.json` (or alongside the JSONL)
- `InvocationResult` enrichment: add `model: str | None = None`, `input_tokens: int | None = None`, `output_tokens: int | None = None`, `cost_usd: float | None = None`
- Orchestrator hooks: after `execute_with_logging()` returns in both `process_wp_implementation` and `process_wp_review`, call `emit_execution_event()` wrapped in try/except
- Map `InvocationResult.duration_seconds` → `duration_ms` (multiply by 1000, round to int)

### Parallel Opportunities
- T016 and T017 can be done in parallel (different functions in `integration.py`).
- T014 (unit tests) and T018 (integration tests) can proceed in parallel.

### Dependencies
- Depends on WP01 (SimpleJsonStore for persistence).

### Risks & Mitigations
- **Clock file corruption**: If `.kittify/telemetry-clock.json` is corrupted, reset clock to 0 (append-only logs tolerate clock resets — events are still dedupable by event_id).
- **Orchestrator test coupling**: Use mock invokers in integration tests to avoid real agent execution.
- **Breaking existing tests**: `InvocationResult` changes are additive (new optional fields). No existing code references these fields.

---

## Work Package WP04: Cost Tracking and Pricing Table (Priority: P1)

**Goal**: Aggregate execution events into cost summaries with a shipping pricing table for cost estimation.
**Independent Test**: Create events with known costs and tokens, run `cost_summary()`, verify totals match manual calculation. Test estimation from pricing table when `cost_usd` is null.
**Prompt**: `tasks/WP04-cost-tracking.md`
**Estimated size**: ~350 lines

### Included Subtasks
- [x] T019 Create `src/specify_cli/telemetry/_pricing.yaml` with default model rates (Anthropic, OpenAI, Google)
- [x] T020 Implement `PricingTable` loader in `src/specify_cli/telemetry/cost.py`
- [x] T021 Implement `cost_summary(events, group_by)` aggregation function returning `list[CostSummary]`
- [x] T022 Add cost estimation logic: when `cost_usd` is null but tokens present, estimate from pricing table
- [x] T023 Write unit tests in `tests/specify_cli/telemetry/test_cost.py`

### Implementation Notes
- `_pricing.yaml` format: `models: { "model-id": { input_per_1k: float, output_per_1k: float } }`
- `PricingTable` loads from `_pricing.yaml` via `Path(__file__).resolve().parent / "_pricing.yaml"`
- `cost_summary()` groups events by `group_by` key ("agent", "model", "feature"), sums `input_tokens`, `output_tokens`, `cost_usd`, counts events
- Estimation: if `event.payload["cost_usd"]` is None/0 and tokens present, compute `(input_tokens / 1000 * input_per_1k) + (output_tokens / 1000 * output_per_1k)`
- `CostSummary` dataclass: `group_key`, `group_by`, `total_input_tokens`, `total_output_tokens`, `total_cost_usd`, `estimated_cost_usd`, `event_count`
- Unknown model in pricing table: estimate as 0.0, flag with "unknown model" in summary

### Parallel Opportunities
- T019 (YAML file) and T020 (loader) can be done together quickly.
- T021 and T022 are tightly coupled (aggregation + estimation).

### Dependencies
- Depends on WP01 (reads events via SimpleJsonStore).
- Does NOT depend on WP03 (emission) — cost aggregation works on any events in the JSONL file.

### Risks & Mitigations
- **Stale pricing**: Ship with best-effort rates, document that prices change. Constitution override path deferred to Feature 045.
- **Float precision**: Use `round(value, 6)` for cost calculations to avoid floating-point drift. Final display rounds to 4 decimal places.

---

## Work Package WP05: CLI Cost Command (Priority: P1)

**Goal**: Add `spec-kitty agent telemetry cost` CLI command with Rich-formatted output and JSON mode.
**Independent Test**: Run CLI against a project with execution events, verify formatted table output. Run with `--json`, verify parseable JSON output. Run against empty project, verify "No execution events found".
**Prompt**: `tasks/WP05-cli-cost-command.md`
**Estimated size**: ~350 lines

### Included Subtasks
- [x] T024 Create `src/specify_cli/cli/commands/agent/telemetry.py` with `cost` command
- [x] T025 Add `--feature`, `--since`/`--until`, `--group-by`, `--json` flags
- [x] T026 Add Rich-formatted table output for cost report (per-group rows + project total)
- [x] T027 Register telemetry sub-command in `src/specify_cli/cli/commands/agent/__init__.py`
- [x] T028 Write CLI integration tests in `tests/specify_cli/cli/commands/test_telemetry_cli.py`

### Implementation Notes
- Command group: `app = typer.Typer(name="telemetry", help="Telemetry and cost tracking")`
- `cost` command: calls `query_project_events()` or `query_execution_events()` with filters, then `cost_summary()`, then renders
- Rich table columns: Group Key, Input Tokens, Output Tokens, Cost (USD), Events, Estimated flag
- Footer row: project totals
- `--json` output: `json.dumps([summary.to_dict() for summary in summaries], indent=2)`
- `--group-by` choices: `agent` (default), `model`, `feature`
- `--since`/`--until`: parse ISO 8601 strings to datetime
- Empty result: print "No execution events found." and exit 0
- Register: `app.add_typer(telemetry.app, name="telemetry")` in agent `__init__.py`

### Parallel Opportunities
- T024-T026 (command implementation) and T027 (registration) are sequential.
- T028 (tests) can begin once the command skeleton exists.

### Dependencies
- Depends on WP02 (query layer) and WP04 (cost aggregation).

### Risks & Mitigations
- **CLI test isolation**: Use `tmp_path` with pre-seeded JSONL files, not real project directories.
- **Rich output testing**: Use `rich.console.Console(file=StringIO())` to capture output for assertions.

---

## Dependency & Execution Summary

```
WP01 (SimpleJsonStore)
  ├──→ WP02 (Query Layer) ──→ WP05 (CLI)
  ├──→ WP03 (Emission + Orchestrator)
  └──→ WP04 (Cost Tracking) ──→ WP05 (CLI)
```

- **Sequence**: WP01 → { WP02, WP03, WP04 in parallel } → WP05
- **Parallelization**: After WP01 completes, WP02, WP03, and WP04 can proceed in parallel (different packages, no file overlap).
- **MVP Scope**: WP01 + WP03 (store + emission) — enables telemetry recording. WP02 + WP04 + WP05 add reporting.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create telemetry `__init__.py` | WP01 | P0 | No |
| T002 | Implement SimpleJsonStore | WP01 | P0 | No |
| T003 | Add stream-parsing for large JSONL | WP01 | P0 | No |
| T004 | Add idempotent write (dedup by event_id) | WP01 | P0 | No |
| T005 | Add malformed-line tolerance | WP01 | P0 | No |
| T006 | Unit tests for SimpleJsonStore | WP01 | P0 | No |
| T007 | Create EventFilter dataclass | WP02 | P0 | No |
| T008 | Implement query_execution_events() | WP02 | P0 | No |
| T009 | Implement query_project_events() | WP02 | P0 | No |
| T010 | Unit tests for query layer | WP02 | P0 | No |
| T011 | Create emit_execution_event() | WP03 | P0 | No |
| T012 | Wire Lamport clock into emission | WP03 | P0 | No |
| T013 | Add fire-and-forget error handling | WP03 | P0 | No |
| T014 | Unit tests for emission | WP03 | P0 | No |
| T015 | Add telemetry fields to InvocationResult | WP03 | P0 | No |
| T016 | Emission hook in process_wp_implementation | WP03 | P0 | Yes |
| T017 | Emission hook in process_wp_review | WP03 | P0 | Yes |
| T018 | Integration tests for orchestrator telemetry | WP03 | P0 | No |
| T019 | Create _pricing.yaml with default rates | WP04 | P1 | No |
| T020 | Implement PricingTable loader | WP04 | P1 | No |
| T021 | Implement cost_summary() aggregation | WP04 | P1 | No |
| T022 | Add cost estimation from pricing table | WP04 | P1 | No |
| T023 | Unit tests for cost aggregation | WP04 | P1 | No |
| T024 | Create telemetry.py CLI command | WP05 | P1 | No |
| T025 | Add CLI flags (feature, since/until, group-by, json) | WP05 | P1 | No |
| T026 | Add Rich-formatted table output | WP05 | P1 | No |
| T027 | Register telemetry sub-command | WP05 | P1 | No |
| T028 | CLI integration tests | WP05 | P1 | No |

<!-- status-model:start -->
## Canonical Status (Generated)
- WP01: done
- WP02: done
- WP03: done
- WP04: done
- WP05: done
<!-- status-model:end -->
