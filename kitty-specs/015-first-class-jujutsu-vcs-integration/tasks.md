# Work Packages: First-Class Jujutsu VCS Integration

**Inputs**: Design documents from `/kitty-specs/015-first-class-jujutsu-vcs-integration/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md, contracts/vcs-protocol.py

**Tests**: Parametrized tests for abstraction parity + `@pytest.mark.jj` for jj-specific tests. No mocking - real VCS execution required.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Lane status is stored in YAML frontmatter (`lane: planned|doing|for_review|done`).

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: VCS Types and Protocol (Priority: P0)

**Goal**: Create the foundational type system and protocol definition for VCS abstraction.
**Independent Test**: Types import without error; Protocol is runtime-checkable; all dataclasses serialize/deserialize correctly.
**Prompt**: `tasks/WP01-vcs-types-and-protocol.md`
**User Stories**: Foundation for US1-US9
**Requirements**: FR-001

### Included Subtasks
- [x] T001 Create `src/specify_cli/core/vcs/` package directory structure
- [x] T002 [P] Implement `src/specify_cli/core/vcs/types.py` with all enums and dataclasses (VCSBackend, SyncStatus, ConflictType, VCSCapabilities, ChangeInfo, ConflictInfo, SyncResult, WorkspaceInfo, OperationInfo, WorkspaceCreateResult)
- [x] T003 [P] Implement `src/specify_cli/core/vcs/protocol.py` with VCSProtocol definition
- [x] T004 [P] Implement `src/specify_cli/core/vcs/exceptions.py` with VCSError hierarchy
- [x] T005 Create `src/specify_cli/core/vcs/__init__.py` with public API exports

### Implementation Notes
1. Create package structure first (T001)
2. Types can be implemented in parallel (T002, T003, T004)
3. __init__.py exports after all modules exist (T005)
4. Reference `contracts/vcs-protocol.py` for exact signatures
5. Reference `data-model.md` for dataclass field documentation

### Parallel Opportunities
- T002, T003, T004 can proceed in parallel after T001

### Dependencies
- None (starting package)

### Risks & Mitigations
- Type incompatibility with existing code: Use gradual typing, test imports early

---

## Work Package WP02: VCS Detection and Factory (Priority: P0)

**Goal**: Implement tool detection and the get_vcs() factory function.
**Independent Test**: `is_jj_available()` and `is_git_available()` return correct values; `get_vcs()` returns appropriate backend based on availability.
**Prompt**: `tasks/WP02-vcs-detection-and-factory.md`
**User Stories**: US1 (P1), US2 (P1)
**Requirements**: FR-002, FR-003, FR-004

### Included Subtasks
- [x] T006 Implement `src/specify_cli/core/vcs/detection.py` with tool detection functions (is_jj_available, is_git_available, get_jj_version, get_git_version, detect_available_backends)
- [x] T007 Implement `get_vcs()` factory function in detection.py
- [x] T008 Add detection exports to `__init__.py`
- [x] T009 Create `tests/specify_cli/core/vcs/test_detection.py` with detection tests

### Implementation Notes
1. Use `shutil.which()` for tool detection
2. Parse version output: `jj --version`, `git --version`
3. Factory function must read meta.json for locked VCS when in feature context
4. Detection should cache results within a session (avoid repeated subprocess calls)

### Parallel Opportunities
- T009 can start once T006 is scaffolded

### Dependencies
- Depends on WP01 (types)

### Risks & Mitigations
- jj not installed on dev machine: Skip jj tests with `@pytest.mark.jj`
- Version parsing edge cases: Handle unexpected output gracefully

---

## Work Package WP03: GitVCS Implementation (Priority: P1)

**Goal**: Implement GitVCS class wrapping existing git operations.
**Independent Test**: All VCSProtocol methods work for git backend; existing git worktree functionality preserved.
**Prompt**: `tasks/WP03-git-vcs-implementation.md`
**User Stories**: US1 (P1), US2 (P1), US3 (P2), US6 (P2)
**Requirements**: FR-001, FR-010, FR-013

### Included Subtasks
- [x] T010 Create `src/specify_cli/core/vcs/git.py` with GitVCS class skeleton
- [x] T011 Implement workspace operations (create_workspace, remove_workspace, get_workspace_info, list_workspaces) wrapping existing git_ops/worktree
- [x] T012 Implement sync operations (sync_workspace, is_workspace_stale)
- [x] T013 Implement conflict operations (detect_conflicts, has_conflicts) with git conflict marker parsing
- [x] T014 Implement commit/change operations (get_current_change, get_changes, commit)
- [x] T015 Implement repository operations (init_repo, is_repo, get_repo_root)
- [x] T016 [P] Implement git-specific standalone functions (git_get_reflog, git_stash, git_stash_pop)
- [x] T017 Create `tests/specify_cli/core/vcs/test_git.py` with git-specific tests

### Implementation Notes
1. Wrap existing `git_ops.py` functions where possible
2. Parse git output for conflict detection (look for conflict markers in files)
3. Use `git worktree` commands for workspace management
4. SyncResult should capture rebase output and detect conflicts

### Parallel Opportunities
- T016 (standalone functions) can proceed alongside protocol methods
- T017 can start once skeleton exists

### Dependencies
- Depends on WP01 (types), WP02 (detection)

### Risks & Mitigations
- Existing git_ops.py behavior change: Keep git_ops.py unchanged, wrap don't modify
- Conflict detection edge cases: Test with various conflict scenarios

---

## Work Package WP04: JujutsuVCS Implementation (Priority: P1)

**Goal**: Implement JujutsuVCS class with full jj CLI integration.
**Independent Test**: All VCSProtocol methods work for jj backend; jj workspace creation/sync/conflict detection verified.
**Prompt**: `tasks/WP04-jujutsu-vcs-implementation.md`
**User Stories**: US1 (P1), US2 (P1), US3 (P2), US4 (P2), US5 (P2), US6 (P2), US8 (P3), US9 (P3)
**Requirements**: FR-001, FR-009, FR-011, FR-012, FR-013, FR-016

### Included Subtasks
- [x] T018 Create `src/specify_cli/core/vcs/jujutsu.py` with JujutsuVCS class skeleton
- [x] T019 Implement workspace operations using `jj workspace add/forget/list`
- [x] T020 Implement sync operations using `jj workspace update-stale`
- [x] T021 Implement conflict operations using `jj status` parsing (conflicts stored, not blocking)
- [x] T022 Implement commit/change operations using `jj log`, `jj describe`, `jj new`
- [x] T023 Implement repository operations using `jj git init --colocate`
- [x] T024 [P] Implement jj-specific standalone functions (jj_get_operation_log, jj_undo_operation, jj_get_change_by_id)
- [x] T025 Create `tests/specify_cli/core/vcs/test_jujutsu.py` with jj-specific tests (@pytest.mark.jj)

### Implementation Notes
1. All tests require real jj installation (no mocking)
2. Use `--config-toml` for consistent jj behavior in tests
3. Parse jj JSON output where available (`jj log -T json`)
4. Handle colocated mode: both `.jj/` and `.git/` when git available
5. Conflict detection: `jj status` shows conflicts differently than git

### Parallel Opportunities
- T024 (standalone functions) can proceed alongside protocol methods
- WP03 and WP04 can proceed in parallel

### Dependencies
- Depends on WP01 (types), WP02 (detection)

### Risks & Mitigations
- jj CLI output format changes: Pin minimum version (0.20+), test against specific version
- Colocated mode edge cases: Test thoroughly with both git and jj commands

---

## Work Package WP05: Init Command Update (Priority: P1)

**Goal**: Update `spec-kitty init` to detect jj, show recommendation message, store VCS preference.
**Independent Test**: `spec-kitty init` with jj installed shows confirmation; without jj shows recommendation message.
**Prompt**: `tasks/WP05-init-command-update.md`
**User Stories**: US1 (P1)
**Requirements**: FR-005, FR-008

### Included Subtasks
- [ ] T026 Update `src/specify_cli/cli/commands/init.py` to import VCS detection
- [ ] T027 Add VCS detection to init workflow
- [ ] T028 Implement info message recommending jj installation when not present
- [ ] T029 Store VCS preference in `.kittify/config.yaml`
- [ ] T030 Add `--vcs=git|jj` flag to init command
- [ ] T031 Update init command tests

### Implementation Notes
1. Detection should run after directory setup
2. Info message should be non-blocking (informational, not error)
3. Config.yaml gets new `vcs:` section with `preferred: auto|jj|git`
4. Message format: "jj detected, will be used for new features" or "Consider installing jj for improved multi-agent workflows"

### Parallel Opportunities
- Can proceed in parallel with WP03/WP04 once WP02 complete

### Dependencies
- Depends on WP02 (detection)

### Risks & Mitigations
- User confusion about VCS choice: Clear messaging about what "auto" means

---

## Work Package WP06: Implement Command Update (Priority: P1)

**Goal**: Update `spec-kitty implement` to use VCS abstraction for workspace creation.
**Independent Test**: `spec-kitty implement WP01` creates jj workspace when feature uses jj, git worktree when feature uses git.
**Prompt**: `tasks/WP06-implement-command-update.md`
**User Stories**: US2 (P1), US3 (P2)
**Requirements**: FR-006, FR-007, FR-009, FR-010, FR-011, FR-012

### Included Subtasks
- [ ] T032 Update `src/specify_cli/cli/commands/implement.py` to import VCS abstraction
- [ ] T033 Modify workspace creation to use `vcs.create_workspace()` instead of direct git commands
- [ ] T034 Add VCS selection to meta.json during feature creation (lock VCS choice)
- [ ] T035 Implement `--base` flag handling for both VCS backends
- [ ] T036 Update sparse-checkout logic for jj workspaces (if applicable)
- [ ] T037 Add stale workspace detection using `vcs.is_workspace_stale()`
- [ ] T038 Update implement command tests with parametrized VCS backend

### Implementation Notes
1. Read VCS from meta.json; default to project preference if not set
2. Lock VCS in meta.json on first workspace creation
3. Sparse-checkout for jj: research if needed (jj may handle differently)
4. --base flag: Use `vcs.create_workspace(base_branch=...)`

### Parallel Opportunities
- T038 (tests) can start once T032-T33 scaffolded

### Dependencies
- Depends on WP03 (GitVCS), WP04 (JujutsuVCS)

### Risks & Mitigations
- Breaking existing git functionality: Extensive testing with git backend
- VCS lock enforcement: Clear error messages when attempting to change mid-feature

---

## Work Package WP07: Sync Command (Priority: P2)

**Goal**: Implement new `spec-kitty sync` command for workspace synchronization.
**Independent Test**: `spec-kitty sync` updates stale workspace and reports conflicts for both VCS backends.
**Prompt**: `tasks/WP07-sync-command.md`
**User Stories**: US4 (P2), US5 (P2), US6 (P2)
**Requirements**: FR-013, FR-014, FR-015, FR-016, FR-017, FR-018, FR-019

### Included Subtasks
- [ ] T039 Create `src/specify_cli/cli/commands/sync.py` with sync command structure
- [ ] T040 Implement sync workflow using `vcs.sync_workspace()`
- [ ] T041 Add conflict reporting with file paths and line ranges
- [ ] T042 Add `--repair` flag for workspace recovery
- [ ] T043 Register sync command in CLI
- [ ] T044 Create `tests/specify_cli/cli/commands/test_sync.py` with parametrized tests

### Implementation Notes
1. Detect current workspace context (which feature, which WP)
2. Call `vcs.sync_workspace()` and display SyncResult
3. For jj: conflicts are stored, operation succeeds
4. For git: conflicts may block, need to handle gracefully
5. --repair flag: Use jj operation log to recover (jj), or git reset for git

### Parallel Opportunities
- Can proceed in parallel with WP08

### Dependencies
- Depends on WP03 (GitVCS), WP04 (JujutsuVCS)

### Risks & Mitigations
- Conflict handling differences between backends: Abstract in SyncResult
- Recovery complexity: Start with basic --repair, document limitations

---

## Work Package WP08: Ops Command (Priority: P3)

**Goal**: Implement new `spec-kitty ops` command for operation log and undo.
**Independent Test**: `spec-kitty ops log` shows history; `spec-kitty ops undo` reverses last operation.
**Prompt**: `tasks/WP08-ops-command.md`
**User Stories**: US7 (P3)
**Requirements**: FR-020, FR-021, FR-022

### Included Subtasks
- [ ] T045 Create `src/specify_cli/cli/commands/ops.py` with ops command group
- [ ] T046 Implement `ops log` subcommand using jj_get_operation_log/git_get_reflog
- [ ] T047 Implement `ops undo` subcommand using jj_undo_operation
- [ ] T048 Add capability checking (warn if backend doesn't support full undo)
- [ ] T049 Register ops command in CLI
- [ ] T050 Create `tests/specify_cli/cli/commands/test_ops.py`

### Implementation Notes
1. ops command has subcommands: log, undo
2. For jj: Full operation log with undo capability
3. For git: Reflog approximation, limited undo (warn user)
4. Display capability differences clearly

### Parallel Opportunities
- Can proceed in parallel with WP07

### Dependencies
- Depends on WP03 (git_get_reflog), WP04 (jj_get_operation_log)

### Risks & Mitigations
- Git undo limitations: Clear messaging that git undo is best-effort
- Operation log size: Implement --limit flag

---

## Work Package WP09: Integration and Polish (Priority: P3)

**Goal**: Update remaining commands to use VCS abstraction, update tests infrastructure, documentation.
**Independent Test**: All spec-kitty commands work with both VCS backends; parametrized test suite passes.
**Prompt**: `tasks/WP09-integration-and-polish.md`
**User Stories**: All (integration)
**Requirements**: FR-023, FR-024

### Included Subtasks
- [ ] T051 Update `src/specify_cli/cli/commands/merge.py` to use VCS abstraction
- [ ] T052 Update `src/specify_cli/core/worktree.py` to use VCS abstraction (or deprecate)
- [ ] T053 Add deprecation warnings to `src/specify_cli/core/git_ops.py`
- [ ] T054 Update `tests/conftest.py` with jj_available fixture and jj marker
- [ ] T055 [P] Create `tests/specify_cli/core/vcs/test_abstraction.py` with parametrized parity tests
- [ ] T056 [P] Update CLAUDE.md with jj workflow documentation
- [ ] T057 [P] Add conflict gate checks to review/accept commands
- [ ] T058 Final integration testing and edge case verification

### Implementation Notes
1. Merge command: Use VCS abstraction for branch operations
2. git_ops.py deprecation: Add `warnings.warn()` to functions
3. Parametrized tests: Test same scenarios with both backends
4. Conflict gates: Block review/merge if `vcs.has_conflicts()` returns True

### Parallel Opportunities
- T055, T056, T057 can proceed in parallel

### Dependencies
- Depends on WP01-WP08 (all prior work packages)

### Risks & Mitigations
- Regression in existing functionality: Comprehensive integration tests
- Documentation drift: Update CLAUDE.md as part of this WP

---

## Dependency & Execution Summary

```
WP01 (Types/Protocol)
  ↓
WP02 (Detection/Factory)
  ↓
  ├──→ WP03 (GitVCS) ──────────┐
  │                             ├──→ WP06 (Implement Cmd)
  └──→ WP04 (JujutsuVCS) ──────┤
                                ├──→ WP07 (Sync Cmd) ─┐
  WP05 (Init Cmd) ←─ WP02      └──→ WP08 (Ops Cmd) ──┼──→ WP09 (Integration)
                                                      │
```

- **Sequence**: WP01 → WP02 → (WP03 ∥ WP04 ∥ WP05) → WP06 → (WP07 ∥ WP08) → WP09
- **Parallelization**:
  - WP03, WP04, WP05 can run in parallel after WP02
  - WP07, WP08 can run in parallel after WP06
- **MVP Scope**: WP01-WP06 delivers core VCS abstraction with init and implement commands working for both backends

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel? |
|---------|---------|-----|----------|-----------|
| T001 | Create vcs/ package structure | WP01 | P0 | No |
| T002 | Implement types.py | WP01 | P0 | Yes |
| T003 | Implement protocol.py | WP01 | P0 | Yes |
| T004 | Implement exceptions.py | WP01 | P0 | Yes |
| T005 | Create __init__.py exports | WP01 | P0 | No |
| T006 | Implement detection functions | WP02 | P0 | No |
| T007 | Implement get_vcs() factory | WP02 | P0 | No |
| T008 | Add detection exports | WP02 | P0 | No |
| T009 | Detection tests | WP02 | P0 | Yes |
| T010 | GitVCS class skeleton | WP03 | P1 | No |
| T011 | GitVCS workspace operations | WP03 | P1 | No |
| T012 | GitVCS sync operations | WP03 | P1 | No |
| T013 | GitVCS conflict operations | WP03 | P1 | No |
| T014 | GitVCS commit/change ops | WP03 | P1 | No |
| T015 | GitVCS repository ops | WP03 | P1 | No |
| T016 | Git standalone functions | WP03 | P1 | Yes |
| T017 | Git-specific tests | WP03 | P1 | Yes |
| T018 | JujutsuVCS class skeleton | WP04 | P1 | No |
| T019 | JujutsuVCS workspace ops | WP04 | P1 | No |
| T020 | JujutsuVCS sync ops | WP04 | P1 | No |
| T021 | JujutsuVCS conflict ops | WP04 | P1 | No |
| T022 | JujutsuVCS commit/change ops | WP04 | P1 | No |
| T023 | JujutsuVCS repository ops | WP04 | P1 | No |
| T024 | jj standalone functions | WP04 | P1 | Yes |
| T025 | jj-specific tests | WP04 | P1 | Yes |
| T026 | Init: import VCS detection | WP05 | P1 | No |
| T027 | Init: add VCS detection | WP05 | P1 | No |
| T028 | Init: jj recommendation message | WP05 | P1 | No |
| T029 | Init: store VCS in config.yaml | WP05 | P1 | No |
| T030 | Init: --vcs flag | WP05 | P1 | No |
| T031 | Init: update tests | WP05 | P1 | Yes |
| T032 | Implement: import VCS | WP06 | P1 | No |
| T033 | Implement: use vcs.create_workspace | WP06 | P1 | No |
| T034 | Implement: VCS in meta.json | WP06 | P1 | No |
| T035 | Implement: --base for both VCS | WP06 | P1 | No |
| T036 | Implement: sparse-checkout for jj | WP06 | P1 | No |
| T037 | Implement: stale workspace detection | WP06 | P1 | No |
| T038 | Implement: parametrized tests | WP06 | P1 | Yes |
| T039 | Sync: command structure | WP07 | P2 | No |
| T040 | Sync: workflow implementation | WP07 | P2 | No |
| T041 | Sync: conflict reporting | WP07 | P2 | No |
| T042 | Sync: --repair flag | WP07 | P2 | No |
| T043 | Sync: register command | WP07 | P2 | No |
| T044 | Sync: parametrized tests | WP07 | P2 | Yes |
| T045 | Ops: command structure | WP08 | P3 | No |
| T046 | Ops: log subcommand | WP08 | P3 | No |
| T047 | Ops: undo subcommand | WP08 | P3 | No |
| T048 | Ops: capability checking | WP08 | P3 | No |
| T049 | Ops: register command | WP08 | P3 | No |
| T050 | Ops: tests | WP08 | P3 | Yes |
| T051 | Integration: merge command | WP09 | P3 | No |
| T052 | Integration: worktree.py update | WP09 | P3 | No |
| T053 | Integration: git_ops deprecation | WP09 | P3 | No |
| T054 | Integration: conftest.py update | WP09 | P3 | No |
| T055 | Integration: parametrized parity tests | WP09 | P3 | Yes |
| T056 | Integration: CLAUDE.md update | WP09 | P3 | Yes |
| T057 | Integration: conflict gates | WP09 | P3 | Yes |
| T058 | Integration: final testing | WP09 | P3 | No |
