---
description: "Work package task list for MCP Server for Conversational Spec Kitty Workflow"
---

# Work Packages: MCP Server for Conversational Spec Kitty Workflow

**Inputs**: Design documents from `kitty-specs/099-mcp-server-for-conversational-spec-kitty-workflow/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md

**Tests**: Integration tests required for MCP client-server interaction, CLI adapter contract tests.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- Single Python project: `src/specify_cli/`, `tests/`
- New MCP server module: `src/specify_cli/mcp/`

---

## Work Package WP01: Core MCP Server Foundation (Priority: P0)

**Goal**: Establish MCP server infrastructure with FastMCP, basic tool registration, and stdio/SSE transport support.
**Independent Test**: Server starts successfully, responds to MCP health check, and can register/list tools.
**Prompt**: `tasks/WP01-core-mcp-server-foundation.md`

### Included Subtasks
- [x] T001 Install FastMCP dependency in pyproject.toml with version constraint
- [x] T002 Create `src/specify_cli/mcp/` module structure with __init__.py
- [x] T003 Implement MCPServer class in `src/specify_cli/mcp/server.py` with configuration (host, port, auth, transport)
- [x] T004 [P] Implement stdio transport handler for MCP communication
- [x] T005 [P] Implement SSE transport handler for MCP communication
- [x] T006 Add server startup command `spec-kitty mcp start` in CLI

### Implementation Notes
- FastMCP handles protocol details; focus on configuration and tool registration
- Server should load config from environment variables with sensible defaults (host=127.0.0.1, port=8000)
- Stdio transport for Claude Desktop/Cursor, SSE for web-based clients

### Parallel Opportunities
- T004 and T005 can proceed in parallel (different transport implementations)

### Dependencies
- None (foundation package)

### Risks & Mitigations
- FastMCP API changes → pin version to `>=1.0.0,<2.0.0`
- Port conflicts → add port availability check on startup

---

## Work Package WP02: Project Context & State Management (Priority: P0)

**Goal**: Implement ProjectContext entity and conversation state persistence using JSON storage in `.kittify/mcp-sessions/`.
**Independent Test**: ProjectContext can be created for a valid project path, conversation state can be saved/loaded from JSON files.
**Prompt**: `tasks/WP02-project-context-and-state-management.md`

### Included Subtasks
- [x] T007 Create ProjectContext dataclass in `src/specify_cli/mcp/session/context.py` with path validation
- [x] T008 Implement project path validation (check for `.kittify/` directory)
- [x] T009 Implement session directory creation (`.kittify/mcp-sessions/`) if not exists
- [x] T010 Create ConversationState dataclass in `src/specify_cli/mcp/session/state.py`
- [x] T011 Implement JSON serialization/deserialization for ConversationState (to_json, from_json methods)
- [x] T012 Implement atomic file write for state persistence (write to .tmp, then rename)
- [x] T013 Add state resumption logic (load from session_id)

### Implementation Notes
- Use Path objects for all file operations
- Atomic writes prevent corruption during crashes
- Session IDs are UUIDs; session files named `{session_id}.json`

### Parallel Opportunities
- T010-T013 can proceed independently from T007-T009 (different modules)

### Dependencies
- Depends on WP01 (MCP server structure exists)

### Risks & Mitigations
- Concurrent writes to same session → handled by pessimistic locking (WP03)
- Invalid JSON → add try/except with error logging

---

## Work Package WP03: File Locking & Concurrency Control (Priority: P0)

**Goal**: Implement pessimistic file-level locking using filelock library to prevent concurrent modifications across multiple MCP clients.
**Independent Test**: Multiple clients attempting to modify the same resource wait for lock release; timeout errors are handled gracefully.
**Prompt**: `tasks/WP03-file-locking-and-concurrency-control.md`

### Included Subtasks
- [x] T014 Install filelock dependency in pyproject.toml
- [x] T015 Create ResourceLock dataclass in `src/specify_cli/mcp/session/locking.py`
- [x] T016 Implement lock acquisition with timeout (default 5 minutes)
- [x] T017 Implement lock release (context manager pattern)
- [x] T018 Add stale lock detection and cleanup (process PID check)
- [x] T019 Implement lock granularity: per-WP, per-feature, per-config-file

### Implementation Notes
- Use filelock.FileLock with context manager (`with lock.acquire(timeout=300):`)
- Lock files stored in `.kittify/.lock-{resource_id}`
- Auto-cleanup on process exit (filelock feature)

### Parallel Opportunities
- None (tight integration)

### Dependencies
- Depends on WP02 (ProjectContext defines lock_dir)

### Risks & Mitigations
- Stale locks from crashes → add PID check and auto-cleanup
- Cross-platform compatibility → filelock handles Windows/Unix differences

---

## Work Package WP04: CLI Adapter Layer (Priority: P0)

**Goal**: Create thin adapter layer that wraps existing CLI modules, providing consistent interface for MCP tools without duplicating business logic.
**Independent Test**: CLIAdapter can invoke existing CLI functions (create_feature, list_tasks, etc.) and return standardized OperationResult.
**Prompt**: `tasks/WP04-cli-adapter-layer.md`

### Included Subtasks
- [x] T020 Create OperationResult dataclass in `src/specify_cli/mcp/adapters/__init__.py` with success, message, data, artifacts, errors fields
- [x] T021 Create CLIAdapter class skeleton in `src/specify_cli/mcp/adapters/cli_adapter.py`
- [x] T022 [P] Implement feature operation adapters (create_feature, setup_plan, create_tasks)
- [x] T023 [P] Implement task operation adapters (list_tasks, move_task, add_history)
- [x] T024 [P] Implement workspace operation adapters (create_worktree, list_worktrees)
- [x] T025 [P] Implement system operation adapters (validate_project, get_missions)
- [x] T026 Add error handling: CLI exceptions → OperationResult with errors

### Implementation Notes
- Each adapter method maps directly to existing CLI functions in `src/specify_cli/cli/` or `src/specify_cli/agent_utils/`
- Use direct Python imports (NOT subprocess calls)
- Standardize return format: all methods return OperationResult

### Parallel Opportunities
- T022-T025 can proceed in parallel (different operation domains)

### Dependencies
- Depends on WP02 (ProjectContext provides project state)

### Risks & Mitigations
- CLI API changes break adapter → add contract tests
- Exceptions leak → wrap all CLI calls in try/except

---

## Work Package WP05: Feature Operations MCP Tools (Priority: P1)

**Goal**: Implement MCP tools for feature workflow operations (specify, plan, tasks, implement, review, accept).
**Independent Test**: MCP client can invoke feature_operations tool with valid parameters and receive OperationResult.
**Prompt**: `tasks/WP05-feature-operations-mcp-tools.md`

### Included Subtasks
- [x] T027 Create feature_tools.py in `src/specify_cli/mcp/tools/`
- [x] T028 Define JSON Schema for feature_operations parameters (project_path, operation, feature_slug, arguments)
- [x] T029 Implement feature_operations_handler that routes to CLIAdapter based on operation enum
- [x] T030 [P] Add specify operation support (discovery interview integration)
- [x] T031 [P] Add plan operation support
- [x] T032 [P] Add tasks operation support
- [x] T033 [P] Add implement operation support
- [x] T034 [P] Add review operation support
- [x] T035 [P] Add accept operation support
- [x] T036 Register feature_operations tool with FastMCP server

### Implementation Notes
- Tool uses single entry point with operation enum parameter (not 6 separate tools)
- Discovery interview state management handled by ConversationState (WP02)
- Each operation validates required parameters before delegating to CLIAdapter

### Parallel Opportunities
- T030-T035 can proceed in parallel (independent operation handlers)

### Dependencies
- Depends on WP04 (CLIAdapter provides feature operation methods)

### Risks & Mitigations
- Complex discovery interview state → defer to existing `/spec-kitty.specify` logic
- Parameter validation → use JSON Schema strictly

---

## Work Package WP06: Task Operations MCP Tools (Priority: P1)

**Goal**: Implement MCP tools for task management operations (list_tasks, move_task, add_history, query_status).
**Independent Test**: MCP client can move tasks between lanes, list tasks by lane, and query task status/dependencies.
**Prompt**: `tasks/WP06-task-operations-mcp-tools.md`

### Included Subtasks
- [x] T037 Create task_tools.py in `src/specify_cli/mcp/tools/`
- [x] T038 Define JSON Schema for task_operations parameters
- [x] T039 Implement task_operations_handler with operation routing
- [x] T040 [P] Add list_tasks operation (with optional lane filter)
- [x] T041 [P] Add move_task operation (with locking via WP03)
- [x] T042 [P] Add add_history operation (append to activity log)
- [x] T043 [P] Add query_status operation (return task lane, dependencies, completion)
- [x] T044 Register task_operations tool with FastMCP server

### Implementation Notes
- move_task MUST acquire lock (use locking.py from WP03)
- list_tasks returns all WP files from `kitty-specs/{feature}/tasks/` directory
- query_status parses frontmatter for dependencies field

### Parallel Opportunities
- T040-T043 can proceed in parallel (independent operations)

### Dependencies
- Depends on WP03 (locking for move_task), WP04 (CLIAdapter)

### Risks & Mitigations
- Concurrent task moves → locking ensures safety
- Activity log corruption → use atomic writes

---

## Work Package WP07: Workspace Operations MCP Tools (Priority: P2)

**Goal**: Implement MCP tools for git worktree management (create_worktree, list_worktrees, merge).
**Independent Test**: MCP client can create worktrees for work packages, list active worktrees, and execute merge workflow.
**Prompt**: `tasks/WP07-workspace-operations-mcp-tools.md`

### Included Subtasks
- [x] T045 Create workspace_tools.py in `src/specify_cli/mcp/tools/`
- [x] T046 Define JSON Schema for workspace_operations parameters
- [x] T047 Implement workspace_operations_handler with operation routing
- [x] T048 [P] Add create_worktree operation (with --base flag support for dependencies)
- [x] T049 [P] Add list_worktrees operation (scan `.worktrees/` directory)
- [x] T050 [P] Add merge operation (with preflight validation)
- [x] T051 Register workspace_operations tool with FastMCP server

### Implementation Notes
- create_worktree delegates to existing `spec-kitty implement` CLI command
- merge delegates to existing merge workflow with preflight checks
- Worktree paths: `.worktrees/{feature-slug}-{wp-id}/`

### Parallel Opportunities
- T048-T050 can proceed in parallel (independent operations)

### Dependencies
- Depends on WP04 (CLIAdapter provides workspace methods)

### Risks & Mitigations
- Git worktree corruption → validate git state before operations
- Merge conflicts → return structured error with resolution guidance

---

## Work Package WP08: System Operations & Health Check (Priority: P2)

**Goal**: Implement system-level MCP tools for health checks, project validation, mission listing, and server configuration.
**Independent Test**: MCP client can query server health, validate project structure, and list available missions.
**Prompt**: `tasks/WP08-system-operations-and-health-check.md`

### Included Subtasks
- [x] T052 Create system_tools.py in `src/specify_cli/mcp/tools/`
- [x] T053 Define JSON Schema for system_operations parameters
- [x] T054 Implement system_operations_handler with operation routing
- [x] T055 [P] Add health_check operation (return server uptime, active projects count)
- [x] T056 [P] Add validate_project operation (check `.kittify/` structure)
- [x] T057 [P] Add list_missions operation (return available missions from config)
- [x] T058 [P] Add server_config operation (return server settings, redacted API key)
- [x] T059 Register system_operations tool with FastMCP server

### Implementation Notes
- health_check returns server status, active project count, uptime
- validate_project checks for `.kittify/`, `config.yaml`, required files
- list_missions reads from mission configurations

### Parallel Opportunities
- T055-T058 can proceed in parallel (independent operations)

### Dependencies
- Depends on WP01 (MCPServer provides server state), WP02 (ProjectContext for validation)

### Risks & Mitigations
- API key leak → ensure redaction in server_config
- Stale health data → add timestamp to health_check response

---

## Work Package WP09: API Key Authentication (Priority: P2)

**Goal**: Implement optional API key authentication for MCP clients with configuration to disable for trusted local environments.
**Independent Test**: Server rejects unauthenticated clients when auth_enabled=True, accepts all clients when auth_enabled=False.
**Prompt**: `tasks/WP09-api-key-authentication.md`

### Included Subtasks
- [x] T060 Create auth module in `src/specify_cli/mcp/auth/`
- [x] T061 Create api_key.py with API key validation logic
- [x] T062 Add auth_enabled configuration flag to MCPServer
- [x] T063 Add api_key configuration (environment variable or config file)
- [x] T064 Implement authentication middleware for FastMCP
- [x] T065 Add authentication error responses (401 Unauthorized)
- [x] T066 Update server startup to log authentication status (enabled/disabled)

### Implementation Notes
- API key passed in MCP connection headers or initial handshake
- If auth_enabled=False, skip authentication (trust all local clients)
- Use constant-time comparison for API key validation (prevent timing attacks)

### Parallel Opportunities
- None (tight integration with server startup)

### Dependencies
- Depends on WP01 (MCPServer initialization)

### Risks & Mitigations
- Weak API keys → require minimum length (32 chars) and entropy check
- Timing attacks → use hmac.compare_digest for validation

---

## Work Package WP10: MCP Client Integration Tests (Priority: P1)

**Goal**: Write comprehensive integration tests using FastMCP test utilities to verify all MCP tools work correctly end-to-end.
**Independent Test**: Test suite passes with 100% tool coverage (all operations tested).
**Prompt**: `tasks/WP10-mcp-client-integration-tests.md`

### Included Subtasks
- [x] T067 Create `tests/mcp/` directory structure
- [x] T068 Write test_server.py for server startup/shutdown/health
- [x] T069 [P] Write test_feature_tools.py for feature_operations tool
- [x] T070 [P] Write test_task_tools.py for task_operations tool
- [x] T071 [P] Write test_workspace_tools.py for workspace_operations tool
- [x] T072 [P] Write test_system_tools.py for system_operations tool
- [x] T073 Write test_cli_adapter.py for CLIAdapter contract tests
- [x] T074 Write test_session_state.py for ConversationState persistence
- [x] T075 Write test_locking.py for concurrent access and timeout behavior

### Implementation Notes
- Use FastMCP test client utilities for tool invocation
- Create fixture projects in `tests/fixtures/mcp-test-projects/`
- Test both happy path and error conditions (invalid params, missing projects, lock timeouts)

### Parallel Opportunities
- T069-T072 can proceed in parallel (independent tool test files)

### Dependencies
- Depends on WP05-WP08 (all MCP tools implemented)

### Risks & Mitigations
- Flaky tests due to timing → add retries and proper cleanup
- Test isolation → use temporary directories per test

---

## Work Package WP11: Documentation & Quickstart Guide (Priority: P2)

**Goal**: Complete the quickstart.md guide with installation, server setup, client configuration, and troubleshooting.
**Independent Test**: New user can follow quickstart.md and successfully run their first MCP command.
**Prompt**: `tasks/WP11-documentation-and-quickstart-guide.md`

### Included Subtasks
- [x] T076 Complete quickstart.md with installation instructions
- [x] T077 [P] Add Claude Desktop MCP configuration example
- [x] T078 [P] Add Cursor MCP configuration example
- [x] T079 [P] Add other MCP client examples (VS Code, etc.)
- [x] T080 Document server startup command and options
- [ ] T081 Add authentication configuration guide
- [ ] T082 Add troubleshooting section (common errors, solutions)
- [ ] T083 Add example conversational workflows (specify → plan → implement)

### Implementation Notes
- Include complete working examples (copy-paste ready)
- Cover both stdio and SSE transports
- Add screenshots or ASCII art for clarity

### Parallel Opportunities
- T077-T079 can proceed in parallel (different client configurations)

### Dependencies
- Depends on WP01-WP09 (all features implemented)

### Risks & Mitigations
- Outdated docs → add version check in quickstart
- Missing edge cases → solicit feedback from beta testers

---

## Work Package WP12: CLI Command Integration & Server Management (Priority: P1)

**Goal**: Integrate MCP server commands into the existing spec-kitty CLI, add server lifecycle management (start, stop, status).
**Independent Test**: User can run `spec-kitty mcp start`, `spec-kitty mcp status`, and `spec-kitty mcp stop` successfully.
**Prompt**: `tasks/WP12-cli-command-integration-and-server-management.md`

### Included Subtasks
- [x] T084 Create mcp command group in `src/specify_cli/cli/commands/`
- [x] T085 Implement `spec-kitty mcp start` command (launch server with config)
- [x] T086 Implement `spec-kitty mcp status` command (check if server running)
- [x] T087 Implement `spec-kitty mcp stop` command (graceful shutdown)
- [x] T088 Add PID file management (store/read/cleanup `.kittify/.mcp-server.pid`)
- [x] T089 Add signal handlers (SIGTERM, SIGINT for graceful shutdown)
- [x] T090 Add server configuration file support (`.kittify/mcp-config.yaml`)

### Implementation Notes
- Server runs as foreground process (manual lifecycle only, no daemon mode)
- PID file prevents multiple server instances
- Graceful shutdown: close connections, release locks, save state

### Parallel Opportunities
- T085-T087 can proceed in parallel (independent commands)

### Dependencies
- Depends on WP01 (MCPServer implemented)

### Risks & Mitigations
- Orphaned PID files → check process existence before failing
- Incomplete shutdown → add timeout for cleanup

---

## Dependency & Execution Summary

- **Critical Path**: WP01 → WP02 → WP03 → WP04 → WP05-WP08 (parallel) → WP10
- **Support Track**: WP09 (auth) and WP12 (CLI integration) can proceed alongside WP05-WP08
- **Finalization**: WP11 (docs) after all features complete
- **Parallelization**: 
  - Phase 1: WP01 → WP02 → WP03 → WP04 (sequential, foundational)
  - Phase 2: WP05, WP06, WP07, WP08, WP09, WP12 (parallel, independent tools)
  - Phase 3: WP10 (integration tests), WP11 (docs)
- **MVP Scope**: WP01-WP06, WP12 (core server, feature/task operations, CLI integration)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Install FastMCP dependency | WP01 | P0 | No |
| T002 | Create mcp module structure | WP01 | P0 | No |
| T003 | Implement MCPServer class | WP01 | P0 | No |
| T004 | Implement stdio transport | WP01 | P0 | Yes |
| T005 | Implement SSE transport | WP01 | P0 | Yes |
| T006 | Add server startup command | WP01 | P0 | No |
| T007 | Create ProjectContext dataclass | WP02 | P0 | No |
| T008 | Implement project path validation | WP02 | P0 | No |
| T009 | Implement session directory creation | WP02 | P0 | No |
| T010 | Create ConversationState dataclass | WP02 | P0 | Yes |
| T011 | Implement JSON serialization | WP02 | P0 | Yes |
| T012 | Implement atomic file write | WP02 | P0 | Yes |
| T013 | Add state resumption logic | WP02 | P0 | Yes |
| T014 | Install filelock dependency | WP03 | P0 | No |
| T015 | Create ResourceLock dataclass | WP03 | P0 | No |
| T016 | Implement lock acquisition | WP03 | P0 | No |
| T017 | Implement lock release | WP03 | P0 | No |
| T018 | Add stale lock detection | WP03 | P0 | No |
| T019 | Implement lock granularity | WP03 | P0 | No |
| T020 | Create OperationResult dataclass | WP04 | P0 | No |
| T021 | Create CLIAdapter class skeleton | WP04 | P0 | No |
| T022 | Implement feature operation adapters | WP04 | P0 | Yes |
| T023 | Implement task operation adapters | WP04 | P0 | Yes |
| T024 | Implement workspace operation adapters | WP04 | P0 | Yes |
| T025 | Implement system operation adapters | WP04 | P0 | Yes |
| T026 | Add error handling | WP04 | P0 | No |
| T027 | Create feature_tools.py | WP05 | P1 | No |
| T028 | Define JSON Schema | WP05 | P1 | No |
| T029 | Implement feature_operations_handler | WP05 | P1 | No |
| T030 | Add specify operation | WP05 | P1 | Yes |
| T031 | Add plan operation | WP05 | P1 | Yes |
| T032 | Add tasks operation | WP05 | P1 | Yes |
| T033 | Add implement operation | WP05 | P1 | Yes |
| T034 | Add review operation | WP05 | P1 | Yes |
| T035 | Add accept operation | WP05 | P1 | Yes |
| T036 | Register feature_operations tool | WP05 | P1 | No |
| T037 | Create task_tools.py | WP06 | P1 | No |
| T038 | Define JSON Schema | WP06 | P1 | No |
| T039 | Implement task_operations_handler | WP06 | P1 | No |
| T040 | Add list_tasks operation | WP06 | P1 | Yes |
| T041 | Add move_task operation | WP06 | P1 | Yes |
| T042 | Add add_history operation | WP06 | P1 | Yes |
| T043 | Add query_status operation | WP06 | P1 | Yes |
| T044 | Register task_operations tool | WP06 | P1 | No |
| T045 | Create workspace_tools.py | WP07 | P2 | No |
| T046 | Define JSON Schema | WP07 | P2 | No |
| T047 | Implement workspace_operations_handler | WP07 | P2 | No |
| T048 | Add create_worktree operation | WP07 | P2 | Yes |
| T049 | Add list_worktrees operation | WP07 | P2 | Yes |
| T050 | Add merge operation | WP07 | P2 | Yes |
| T051 | Register workspace_operations tool | WP07 | P2 | No |
| T052 | Create system_tools.py | WP08 | P2 | No |
| T053 | Define JSON Schema | WP08 | P2 | No |
| T054 | Implement system_operations_handler | WP08 | P2 | No |
| T055 | Add health_check operation | WP08 | P2 | Yes |
| T056 | Add validate_project operation | WP08 | P2 | Yes |
| T057 | Add list_missions operation | WP08 | P2 | Yes |
| T058 | Add server_config operation | WP08 | P2 | Yes |
| T059 | Register system_operations tool | WP08 | P2 | No |
| T060 | Create auth module | WP09 | P2 | No |
| T061 | Create api_key.py | WP09 | P2 | No |
| T062 | Add auth_enabled flag | WP09 | P2 | No |
| T063 | Add api_key configuration | WP09 | P2 | No |
| T064 | Implement authentication middleware | WP09 | P2 | No |
| T065 | Add authentication error responses | WP09 | P2 | No |
| T066 | Update server startup logging | WP09 | P2 | No |
| T067 | Create tests/mcp/ directory | WP10 | P1 | No |
| T068 | Write test_server.py | WP10 | P1 | No |
| T069 | Write test_feature_tools.py | WP10 | P1 | Yes |
| T070 | Write test_task_tools.py | WP10 | P1 | Yes |
| T071 | Write test_workspace_tools.py | WP10 | P1 | Yes |
| T072 | Write test_system_tools.py | WP10 | P1 | Yes |
| T073 | Write test_cli_adapter.py | WP10 | P1 | No |
| T074 | Write test_session_state.py | WP10 | P1 | No |
| T075 | Write test_locking.py | WP10 | P1 | No |
| T076 | Complete quickstart.md | WP11 | P2 | No |
| T077 | Add Claude Desktop config | WP11 | P2 | Yes |
| T078 | Add Cursor config | WP11 | P2 | Yes |
| T079 | Add other client examples | WP11 | P2 | Yes |
| T080 | Document server startup | WP11 | P2 | No |
| T081 | Add authentication guide | WP11 | P2 | No |
| T082 | Add troubleshooting section | WP11 | P2 | No |
| T083 | Add example workflows | WP11 | P2 | No |
| T084 | Create mcp command group | WP12 | P1 | No |
| T085 | Implement mcp start command | WP12 | P1 | Yes |
| T086 | Implement mcp status command | WP12 | P1 | Yes |
| T087 | Implement mcp stop command | WP12 | P1 | Yes |
| T088 | Add PID file management | WP12 | P1 | No |
| T089 | Add signal handlers | WP12 | P1 | No |
| T090 | Add server config file support | WP12 | P1 | No |

---

> This task breakdown provides 12 work packages with 90 subtasks total. Work packages are sized appropriately (6-9 subtasks each) to enable focused implementation and thorough testing.
