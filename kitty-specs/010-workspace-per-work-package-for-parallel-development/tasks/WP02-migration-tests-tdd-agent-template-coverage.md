---
work_package_id: WP02
title: Migration Tests (TDD - Template Source Validation)
lane: done
history:
- timestamp: '2026-01-07T00:00:00Z'
  lane: planned
  agent: system
  shell_pid: ''
  action: Prompt generated via /spec-kitty.tasks
- timestamp: '2026-01-08T09:24:49Z'
  agent: system
  shell_pid: ''
  action: Started implementation via workflow command
- timestamp: '2026-01-08T10:00:00Z'
  agent: claude
  shell_pid: ''
  action: 'CORRECTED: Changed from testing agent directories (gitignored) to testing template sources (committed)'
agent: team
assignee: team
dependencies: [WP01]
phase: Phase 0 - Test Infrastructure
review_status: ''
reviewed_by: ''
shell_pid: manual
subtasks:
- T008
- T009
- T010
- T011
- T012
- T013
---

# Work Package Prompt: WP02 – Migration Tests (CORRECTED - Template Source Validation)

**Implementation command:**
```bash
spec-kitty implement WP02 --base WP01
```

## ⚠️ CRITICAL CORRECTION

**Original WP02 was WRONG**: Attempted to test agent directories (`.claude/`, `.gemini/`, etc.) which are gitignored and don't exist in repo.

**Corrected approach**: Test template SOURCE files in `.kittify/missions/software-dev/command-templates/` which are committed and version-controlled.

---

## Objectives & Success Criteria

**Primary Goal**: Write migration tests that verify template SOURCE files are updated for workspace-per-WP workflow. Tests must FAIL initially to ensure WP07 updates templates correctly.

**Success Criteria**:
- ✅ test_workspace_per_wp_migration.py created
- ✅ Tests validate 4 template source files (specify, plan, tasks, implement)
- ✅ Tests check content (not just existence)
- ✅ All tests FAIL initially (templates not yet updated)
- ✅ Tests will PASS after WP07 updates template sources

**Reduced Scope**: Testing 4 template files (not 48 agent files) since agent directories are generated from templates.

---

## Context & Constraints

**Template Architecture**:

**Source Templates** (committed, version-controlled):
```
.kittify/missions/software-dev/command-templates/
├── specify.md      ← Test this
├── plan.md         ← Test this
├── tasks.md        ← Test this
└── implement.md    ← Test this (NEW in 0.11.0)
```

**Agent Directories** (gitignored, runtime-generated):
```
.claude/commands/       ← Generated by generate_agent_assets()
.gemini/commands/       ← Generated (uses .toml extension!)
.cursor/commands/       ← Generated
(etc... all 12 agents)
```

**How it works**:
1. Migration (WP07) updates 4 template sources
2. User runs `spec-kitty init` → `generate_agent_assets()` reads templates
3. Agent-specific files generated with correct extensions (.md, .toml, .prompt.md)
4. All 12 agents get updated content from template sources

**Why this is better**:
- Only 4 files to update (not 48)
- Template sources are committed (testable in CI)
- Agent directories are generated (don't exist in checkout)
- Single source of truth (templates)

**Reference**:
- `src/specify_cli/core/config.py` - AGENT_COMMAND_CONFIG (agent extensions)
- `src/specify_cli/template/asset_generator.py` - generate_agent_assets()

---

## Subtasks & Detailed Guidance

### Subtask T008 – Create migration test file

**Purpose**: Create test file for validating template source updates.

**Steps**:
1. Create `tests/specify_cli/test_workspace_per_wp_migration.py`
2. Add imports:
   ```python
   from pathlib import Path
   import pytest
   ```

3. Define template directory constant:
   ```python
   TEMPLATE_DIR = Path(".kittify/missions/software-dev/command-templates")
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Parallel?**: No (foundation for T009-T013)

---

### Subtask T009 – Test template directory exists

**Purpose**: Validate template source directory exists (sanity check).

**Steps**:
1. Write test:
   ```python
   def test_template_directory_exists():
       """Verify template source directory exists."""
       template_dir = Path(".kittify/missions/software-dev/command-templates")
       assert template_dir.exists(), "Template directory not found"
       assert template_dir.is_dir(), "Template path is not a directory"
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Parallel?**: Can write in parallel with T010-T013

---

### Subtask T010 – Test specify.md template updates

**Purpose**: Validate specify.md template has workspace-per-WP workflow (no worktree creation).

**Steps**:
1. Write test:
   ```python
   def test_specify_template_updated():
       """Verify specify.md template updated for workspace-per-WP."""
       specify_template = Path(".kittify/missions/software-dev/command-templates/specify.md")
       assert specify_template.exists(), "specify.md template not found"

       content = specify_template.read_text()

       # Should NOT contain worktree creation instructions
       assert ".worktrees" not in content or "NO worktree" in content, \
           "specify.md still mentions creating worktrees"

       # SHOULD contain main repo workflow
       assert "commit" in content.lower() and "main" in content.lower(), \
           "specify.md doesn't mention committing to main"

       # Should mention new workflow
       assert "0.11" in content or "workspace-per-wp" in content.lower(), \
           "specify.md doesn't document version change"
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Expected**: Test FAILS initially (template not yet updated)

**Parallel?**: Can write in parallel with T011-T013

---

### Subtask T011 – Test plan.md template updates

**Purpose**: Validate plan.md template works in main repo (no worktree references).

**Steps**:
1. Write test:
   ```python
   def test_plan_template_updated():
       """Verify plan.md template updated for main repo workflow."""
       plan_template = Path(".kittify/missions/software-dev/command-templates/plan.md")
       assert plan_template.exists(), "plan.md template not found"

       content = plan_template.read_text()

       # Should NOT reference navigating to worktree
       worktree_refs = ["navigate to", "cd .worktrees", "in worktree", "from worktree"]
       for ref in worktree_refs:
           assert ref not in content.lower() or "main repo" in content.lower(), \
               f"plan.md still references worktree navigation: '{ref}'"

       # SHOULD mention working in main
       assert "main repo" in content.lower() or "main branch" in content.lower(), \
           "plan.md doesn't mention working in main repository"
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Parallel?**: Can write in parallel

---

### Subtask T012 – Test tasks.md template updates

**Purpose**: Validate tasks.md template includes dependency generation instructions.

**Steps**:
1. Write test:
   ```python
   def test_tasks_template_updated():
       """Verify tasks.md template includes dependency generation."""
       tasks_template = Path(".kittify/missions/software-dev/command-templates/tasks.md")
       assert tasks_template.exists(), "tasks.md template not found"

       content = tasks_template.read_text()

       # SHOULD mention dependencies
       assert "dependencies" in content.lower(), \
           "tasks.md doesn't mention dependencies field"

       # SHOULD mention parsing dependencies
       assert "parse" in content.lower() or "detect" in content.lower(), \
           "tasks.md doesn't mention dependency detection"

       # SHOULD mention frontmatter generation
       assert "frontmatter" in content.lower(), \
           "tasks.md doesn't mention frontmatter generation"

       # SHOULD mention implement command with --base
       assert "implement" in content and "--base" in content, \
           "tasks.md doesn't document implement command with --base flag"
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Parallel?**: Can write in parallel

---

### Subtask T013 – Test implement.md template exists (NEW)

**Purpose**: Validate implement.md template was created (new in 0.11.0).

**Steps**:
1. Write test:
   ```python
   def test_implement_template_exists():
       """Verify implement.md template exists (new in 0.11.0)."""
       implement_template = Path(".kittify/missions/software-dev/command-templates/implement.md")
       assert implement_template.exists(), "implement.md template not found (should be NEW in 0.11.0)"

       content = implement_template.read_text()

       # SHOULD document spec-kitty implement command
       assert "spec-kitty implement" in content, \
           "implement.md doesn't document implement command"

       # SHOULD document --base flag
       assert "--base" in content, \
           "implement.md doesn't document --base flag"

       # SHOULD include examples
       assert "WP01" in content or "example" in content.lower(), \
           "implement.md doesn't include examples"

       # SHOULD mention workspace creation
       assert "workspace" in content.lower() or "worktree" in content.lower(), \
           "implement.md doesn't mention workspace creation"
   ```

**Files**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Parallel?**: Can write in parallel

---

### Subtask T014 – Test pre-upgrade validation (REMOVED)

**Purpose**: This subtask is REMOVED - pre-upgrade validation is in migration code, not template tests.

**Rationale**: WP02 tests template sources, not migration logic. Pre-upgrade validation will be tested in WP07 integration tests.

---

### Subtask T015 – Run tests, verify FAIL

**Purpose**: Execute test suite and confirm all tests FAIL (templates not yet updated).

**Steps**:
1. Run test suite:
   ```bash
   pytest tests/specify_cli/test_workspace_per_wp_migration.py -v
   ```

2. Verify all tests FAIL:
   - test_template_directory_exists → PASS (directory exists)
   - test_specify_template_updated → FAIL (not yet updated)
   - test_plan_template_updated → FAIL (not yet updated)
   - test_tasks_template_updated → FAIL (not yet updated)
   - test_implement_template_exists → FAIL (doesn't exist yet)

3. This validates tests are actually checking - they'll PASS after WP07 updates templates

**Expected Output**:
```
FAILED test_specify_template_updated - AssertionError: specify.md still mentions creating worktrees
FAILED test_plan_template_updated - AssertionError: plan.md still references worktree navigation
FAILED test_tasks_template_updated - AssertionError: tasks.md doesn't mention dependencies field
FAILED test_implement_template_exists - AssertionError: implement.md template not found
```

**Files**: N/A (test execution)

**Parallel?**: No (validation step)

---

## Test Strategy

**Test File**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**What We Test**: 4 template source files in `.kittify/missions/software-dev/command-templates/`

**What We DON'T Test**: Agent directories (`.claude/`, `.gemini/`, etc.) - gitignored, not in repo

**Execution**:
```bash
# Run from current worktree
pytest tests/specify_cli/test_workspace_per_wp_migration.py -v
```

**Expected**: Tests FAIL initially (templates not updated yet)
**After WP07**: Tests PASS (templates updated)

---

## Why This Approach is Correct

**Agent Directories Are Generated**:
- `.claude/`, `.gemini/`, etc. created by `generate_agent_assets()`
- Called during `spec-kitty init`
- Uses `AGENT_COMMAND_CONFIG` to determine extensions (.md, .toml, .prompt.md)
- Reads from template sources, writes to agent directories

**Template Sources Are Canonical**:
- Committed to repo (`.kittify/missions/software-dev/command-templates/`)
- Single source of truth
- Migration updates these (WP07)
- All 12 agents get content from same templates

**Testing Strategy**:
- ✅ Test 4 template sources (spec-kitty repo)
- ✅ WP07 updates 4 template files
- ✅ Users get updated agent files after upgrade + init
- ❌ Don't test 48 generated files (not in repo, can't test in CI)

---

## Risks & Mitigations

**Risk 1: Template updates don't propagate to generated files**
- Impact: Users upgrade but agent directories have old content
- Mitigation: Document in migration guide: "Run spec-kitty init in existing projects to regenerate agent files" OR migration auto-regenerates

**Risk 2: Tests don't catch template content issues**
- Impact: Templates updated but content is wrong
- Mitigation: Content validation (check for key phrases, not just existence)

---

## Definition of Done Checklist

- [ ] Migration test file created (T008)
- [ ] Template directory existence test written (T009)
- [ ] specify.md template test written (T010)
- [ ] plan.md template test written (T011)
- [ ] tasks.md template test written (T012)
- [ ] implement.md template test written (T013)
- [ ] All tests run and FAIL (T015)
- [ ] Tests validate CONTENT (not just file existence)

---

## Review Guidance

**Reviewers should verify**:
1. **Tests target template sources**: `.kittify/missions/software-dev/command-templates/`, NOT agent directories
2. **Content validation**: Tests check for key phrases (not just file existence)
3. **Tests FAIL initially**: Validates they actually check conditions
4. **Clear error messages**: When test fails, error explains what's missing

---

## Review Feedback

- test_specify_template_updated only checks `.worktrees` lines when the file also contains the word "feature"; this can miss unintended worktree instructions that omit "feature". Drop the extra condition and evaluate every `.worktrees` mention (and compare in a case-insensitive way).
- test_plan_template_updated only blocks four exact phrases and can still pass if the template references worktrees with different wording (e.g., "in the worktree" or "from the worktree"). Broaden the check to catch generic worktree navigation mentions or verify the absence of any "worktree" phrasing unless explicitly negated.

## Activity Log

- 2026-01-07T00:00:00Z – system – lane=planned – Prompt created via /spec-kitty.tasks
- 2026-01-08T09:24:49Z – agent – lane=doing – Started implementation
- 2026-01-08T10:00:00Z – claude – lane=doing – CORRECTED: Template sources, not agent directories

---
- 2026-01-08T09:59:42Z – unknown – lane=for_review – Migration tests complete. Tests validate 4 template sources (not 48 agent files). Tests FAIL as expected (TDD): specify.md needs commit workflow, tasks.md needs dependencies, implement.md needs --base docs. Tests will PASS after WP07 updates templates.
- 2026-01-08T09:59:48Z – agent – lane=doing – Started review via workflow command
- 2026-01-08T10:00:33Z – unknown – lane=planned – Changes requested
- 2026-01-08T10:01:31Z – agent – lane=doing – Started implementation via workflow command
- 2026-01-08T10:04:02Z – unknown – lane=for_review – Review feedback addressed: (1) Strengthened .worktrees validation - now checks ANY mention case-insensitively, not just when 'feature' appears. (2) Strengthened plan.md worktree check - catches generic worktree language, requires explicit negation. Tests now properly FAIL (4/5) as expected in TDD. Will PASS after WP07 updates templates.
- 2026-01-08T10:04:07Z – agent – lane=doing – Started review via workflow command
- 2026-01-08T10:04:19Z – unknown – lane=done – Review passed

## Original WP02 Issues (Documented for Learning)

**Issue 1**: Tested `.claude/commands/specify.md` (doesn't exist - gitignored)
**Issue 2**: Assumed all agents use `.md` extension (Gemini/Qwen use `.toml`)
**Issue 3**: Tried to test 48 files (12 agents × 4 templates) - unnecessary

**Root cause**: Misunderstood template architecture. Agent directories are GENERATED, not source.

**Lesson**: Always verify file existence in repo before writing tests!
