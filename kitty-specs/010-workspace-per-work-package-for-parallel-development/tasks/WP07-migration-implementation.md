---
work_package_id: WP07
title: Migration Implementation
lane: done
history:
- timestamp: '2026-01-07T00:00:00Z'
  lane: planned
  agent: system
  shell_pid: ''
  action: Prompt generated via /spec-kitty.tasks
- timestamp: '2026-01-08T10:05:00Z'
  agent: claude
  shell_pid: ''
  action: 'CORRECTED: Changed from updating 48 agent directory files to updating 4 template source files'
agent: Codex
assignee: team
dependencies: [WP02]
phase: Phase 2 - Migration & Templates
review_status: ''
reviewed_by: ''
shell_pid: '80475'
subtasks:
- T049
- T050
- T051
- T052
- T053
- T054
- T055
- T056
- T057
- T058
---

# Work Package Prompt: WP07 – Migration Implementation (CORRECTED)

**Implementation command:**
```bash
spec-kitty implement WP07 --base WP02
```

## ⚠️ CRITICAL CORRECTION

**Original WP07 was WRONG**: Attempted to update 48 agent directory files (T053-T067) which are gitignored and generated from templates.

**Corrected approach**: Update 4 template SOURCE files in `.kittify/missions/software-dev/command-templates/` which propagate to all 12 agents when generated.

---

## Objectives & Success Criteria

**Primary Goal**: Implement migration `m_0_11_0_workspace_per_wp.py` with pre-upgrade validation and update template SOURCE files. Make migration tests (WP02) pass.

**Success Criteria**:
- ✅ Migration file created with pre-upgrade validation logic
- ✅ 4 template source files updated (specify, plan, tasks) + 1 created (implement)
- ✅ Migration tests (WP02) pass 100%
- ✅ Pre-upgrade validation blocks when legacy worktrees exist
- ✅ list-legacy-features utility command created

**Reduced Scope**: 10 subtasks (down from 21) - update template sources, not generated agent directories.

---

## Context & Constraints

**Template Architecture**:

**Source Templates** (committed, what we update):
```
.kittify/missions/software-dev/command-templates/
├── specify.md      ← UPDATE (remove worktree creation)
├── plan.md         ← UPDATE (remove worktree navigation)
├── tasks.md        ← UPDATE (add dependency generation)
└── implement.md    ← CREATE NEW
```

**Generated Agent Directories** (gitignored, runtime-generated):
```
.claude/commands/       ← Generated by generate_agent_assets()
.gemini/commands/       ← Generated (.toml extension!)
.cursor/commands/       ← Generated
... (all 12 agents)
```

**How Template Updates Propagate**:
1. Migration updates 4 template sources (this WP)
2. User upgrades to 0.11.0
3. User runs `spec-kitty init` in new/existing project
4. `generate_agent_assets()` reads template sources
5. Generates agent-specific files with correct extensions (.md, .toml, .prompt.md)
6. All 12 agents get updated content from single template source

**Why This is Better**:
- ✅ Update 4 files instead of 48
- ✅ Single source of truth (templates)
- ✅ Testable in CI (templates are committed)
- ✅ Agent-specific formatting handled by generator

**Reference**:
- `src/specify_cli/core/config.py` - AGENT_COMMAND_CONFIG (extensions per agent)
- `src/specify_cli/template/asset_generator.py` - generate_agent_assets()
- `src/specify_cli/upgrade/migrations/m_0_10_9_repair_templates.py` - Example migration updating templates

---

## Subtasks & Detailed Guidance

### Subtask T049 – Create migration file

**Purpose**: Create migration file structure for 0.11.0 upgrade.

**Steps**:
1. Create `src/specify_cli/upgrade/migrations/m_0_11_0_workspace_per_wp.py`
2. Add migration metadata:
   ```python
   """Migration for workspace-per-WP feature (0.11.0).

   Breaking change: Planning commands no longer create worktrees.
   Blocks upgrade if legacy worktrees exist.
   Updates template sources in .kittify/missions/software-dev/command-templates/
   """

   MIGRATION_ID = "m_0_11_0_workspace_per_wp"
   MIGRATION_VERSION = "0.11.0"
   MIGRATION_DESCRIPTION = "Workspace-per-WP model with dependency tracking"
   ```

3. Define migration functions (to be implemented in T050-T058):
   - `validate_upgrade()`
   - `detect_legacy_worktrees()`
   - `update_template_sources()`
   - `run_migration()`

**Files**: `src/specify_cli/upgrade/migrations/m_0_11_0_workspace_per_wp.py`

**Parallel?**: No (foundation for T050-T058)

---

### Subtask T050 – Implement pre-upgrade validation

**Purpose**: Block upgrade to 0.11.0 if any legacy worktrees exist.

**Steps**:
1. Implement validation function:
   ```python
   def validate_upgrade(project_root: Path) -> tuple[bool, list[str]]:
       """Validate project is ready for 0.11.0 upgrade.

       Returns: (is_valid, error_messages)
       """
       legacy_worktrees = detect_legacy_worktrees(project_root)

       if legacy_worktrees:
           errors = [
               "Cannot upgrade to 0.11.0 - legacy worktrees detected:",
               ""
           ]
           for wt in legacy_worktrees:
               errors.append(f"  - {wt.name}")

           errors.extend([
               "",
               "Action required before upgrade:",
               "  1. Complete features: spec-kitty merge <feature>",
               "  2. OR delete worktrees: git worktree remove .worktrees/<feature>",
               "",
               "Use: spec-kitty list-legacy-features to see all legacy worktrees"
           ])
           return False, errors

       return True, []
   ```

2. Call validation in migration's run_migration() function

**Files**: `src/specify_cli/upgrade/migrations/m_0_11_0_workspace_per_wp.py`

**Parallel?**: No (sequential with T051)

---

### Subtask T051 – Implement legacy worktree detection

**Purpose**: Scan `.worktrees/` directory for legacy pattern (###-feature without -WP## suffix).

**Steps**:
1. Implement detection function:
   ```python
   def detect_legacy_worktrees(project_root: Path) -> list[Path]:
       """Find legacy worktrees (pre-0.11.0).

       Legacy pattern: .worktrees/###-feature-name/
       New pattern: .worktrees/###-feature-name-WP##/

       Returns: List of legacy worktree paths
       """
       worktrees_dir = project_root / ".worktrees"
       if not worktrees_dir.exists():
           return []

       legacy_worktrees = []

       for item in worktrees_dir.iterdir():
           if not item.is_dir():
               continue

           # Check if name matches feature pattern (###-anything)
           # but does NOT match workspace-per-WP pattern (###-anything-WP##)
           name = item.name
           has_feature_pattern = re.match(r'^\d{3}-', name)
           has_wp_suffix = re.search(r'-WP\d{2}$', name)

           if has_feature_pattern and not has_wp_suffix:
               # This is a legacy worktree
               legacy_worktrees.append(item)

       return legacy_worktrees
   ```

**Files**: `src/specify_cli/upgrade/migrations/m_0_11_0_workspace_per_wp.py`

**Test Example**:
```python
def test_detect_legacy_worktrees(tmp_path):
    """Test detection of legacy vs new worktrees."""
    worktrees = tmp_path / ".worktrees"
    (worktrees / "008-unified-cli").mkdir(parents=True)  # Legacy
    (worktrees / "010-workspace-per-wp-WP01").mkdir(parents=True)  # New
    (worktrees / "010-workspace-per-wp-WP02").mkdir(parents=True)  # New

    legacy = detect_legacy_worktrees(tmp_path)
    assert len(legacy) == 1
    assert legacy[0].name == "008-unified-cli"
```

**Parallel?**: No (called by T050)

---

### Subtask T052 – Block upgrade with clear error

**Purpose**: When legacy worktrees detected, fail migration with actionable error message.

**Steps**:
1. Format error message in run_migration():
   ```python
   def run_migration(project_root: Path, console: Console) -> bool:
       """Run 0.11.0 migration."""
       # Pre-flight validation
       is_valid, errors = validate_upgrade(project_root)
       if not is_valid:
           console.print("\n[bold red]❌ Cannot upgrade to 0.11.0[/bold red]\n")
           for err in errors:
               console.print(err)
           console.print()
           return False

       # If valid, proceed with template updates
       update_template_sources(project_root, console)
       return True
   ```

2. Exit migration without making changes if validation fails

**Files**: `src/specify_cli/upgrade/migrations/m_0_11_0_workspace_per_wp.py`

**Example Error Output**:
```
❌ Cannot upgrade to 0.11.0

Legacy worktrees detected:
  - 008-unified-python-cli
  - 009-jujutsu-vcs-integration

Action required before upgrade:
  1. Complete features: spec-kitty merge 008-unified-python-cli
  2. OR delete worktrees: git worktree remove .worktrees/008-unified-python-cli

Use: spec-kitty list-legacy-features to see all legacy worktrees
```

**Parallel?**: No (error handling in T050)

---

### Subtask T053 – Update specify.md template source

**Purpose**: Update template source to remove worktree creation, add main repo workflow.

**Steps**:
1. Open `.kittify/missions/software-dev/command-templates/specify.md`
2. Find section about worktree creation (likely mentions "Creates `.worktrees/###-feature/`")
3. REMOVE that section entirely
4. ADD new section explaining 0.11.0 workflow:
   ```markdown
   ## Workflow (0.11.0+)

   **Planning happens in main repository - NO worktree created!**

   1. Creates `kitty-specs/###-feature/spec.md` directly in main repo
   2. Automatically commits to main branch
   3. No worktree created during specify

   **Worktrees created later**: Use `spec-kitty implement WP##` to create workspace for each work package.

   ## Location

   - Work in: **Main repository** (not worktree)
   - Creates: `kitty-specs/###-feature/spec.md`
   - Commits to: `main` branch
   ```

5. Update any "navigate to worktree" instructions (remove them)

**Files**: `.kittify/missions/software-dev/command-templates/specify.md`

**Validation**: After update, WP02 test `test_specify_template_updated()` should PASS

**Parallel?**: Can update in parallel with T054-T056 (different files)

---

### Subtask T054 – Update plan.md template source

**Purpose**: Update template to work in main repository without worktree context.

**Steps**:
1. Open `.kittify/missions/software-dev/command-templates/plan.md`
2. Find any references to "worktree", "feature branch", "navigate to"
3. REMOVE worktree-specific instructions
4. UPDATE location instructions:
   ```markdown
   ## Location Check

   This command works in the **main repository**, NOT in a worktree.

   - Verify you're on the main branch
   - Planning artifacts are in: `kitty-specs/###-feature/`
   - Auto-commits plan.md to main after generation
   ```

5. Remove any `cd` commands to worktree directories

**Files**: `.kittify/missions/software-dev/command-templates/plan.md`

**Validation**: After update, WP02 test `test_plan_template_updated()` should PASS

**Parallel?**: Can update in parallel with T053, T055-T056

---

### Subtask T055 – Update tasks.md template source

**Purpose**: Update template to parse dependencies and generate them in WP frontmatter.

**Steps**:
1. Open `.kittify/missions/software-dev/command-templates/tasks.md`
2. Add new section about dependency detection:
   ```markdown
   ## Dependency Detection (0.11.0+)

   **Parse dependencies from tasks.md structure**:

   The LLM should analyze tasks.md for dependency relationships:
   - Explicit phrases: "Depends on WP##", "Dependencies: WP##"
   - Phase grouping: Phase 2 WPs typically depend on Phase 1
   - Default to empty if unclear

   **Generate dependencies in WP frontmatter**:

   Each WP prompt file MUST include dependencies field:
   ```yaml
   ---
   work_package_id: "WP02"
   title: "Build API"
   lane: "planned"
   dependencies: ["WP01"]  # ← GENERATE THIS
   subtasks: ["T001", "T002"]
   ---
   ```

   **Include correct implementation command**:
   - No dependencies: `spec-kitty implement WP01`
   - With dependencies: `spec-kitty implement WP02 --base WP01`

   The WP prompt must show the correct command so agents don't branch from wrong base.
   ```

3. Update WP prompt generation section to mention dependencies field
4. Add note about auto-commit to main after tasks generation

**Files**: `.kittify/missions/software-dev/command-templates/tasks.md`

**Validation**: After update, WP02 test `test_tasks_template_updated()` should PASS

**Parallel?**: Can update in parallel with T053-T054, T056

---

### Subtask T056 – Create implement.md template source (NEW)

**Purpose**: Create NEW template documenting the implement command.

**Steps**:
1. Create `.kittify/missions/software-dev/command-templates/implement.md`
2. Document command purpose and syntax:
   ```markdown
   # /spec-kitty.implement - Create Workspace for Work Package

   **Version**: 0.11.0+
   **Purpose**: Create isolated workspace (git worktree) for implementing a specific work package.

   ## Command Syntax

   ```bash
   spec-kitty implement WP##              # No dependencies (branches from main)
   spec-kitty implement WP## --base WPXX  # With dependencies (branches from base WP)
   ```

   ## When to Use

   After `/spec-kitty.tasks` has generated work packages in main repository:
   - Planning artifacts (spec, plan, tasks) are already in main
   - Run `spec-kitty implement WP01` to create workspace for first WP
   - Run `spec-kitty implement WP02 --base WP01` if WP02 depends on WP01
   - Each WP gets its own isolated worktree in `.worktrees/###-feature-WP##/`

   ## Workflow

   **Planning Phase** (in main, no worktrees):
   ```
   /spec-kitty.specify → Creates spec.md in main
   /spec-kitty.plan → Creates plan.md in main
   /spec-kitty.tasks → Creates tasks/*.md in main
   ```

   **Implementation Phase** (creates worktrees on-demand):
   ```
   spec-kitty implement WP01 → Creates .worktrees/###-feature-WP01/
   spec-kitty implement WP02 --base WP01 → Creates .worktrees/###-feature-WP02/
   ```

   ## Examples

   **Independent WP** (no dependencies):
   ```bash
   spec-kitty implement WP01
   # Creates: .worktrees/010-workspace-per-wp-WP01/
   # Branches from: main
   # Contains: Planning artifacts (spec, plan, tasks)
   ```

   **Dependent WP**:
   ```bash
   spec-kitty implement WP02 --base WP01
   # Creates: .worktrees/010-workspace-per-wp-WP02/
   # Branches from: 010-workspace-per-wp-WP01 branch
   # Contains: Planning artifacts + WP01's code changes
   ```

   ## Validation

   The command validates:
   - Base workspace exists (if --base specified)
   - Suggests --base if WP has dependencies in frontmatter
   - Errors if trying to branch from non-existent base

   ## Parallel Development

   Multiple agents can implement different WPs simultaneously:
   ```bash
   # Agent A
   spec-kitty implement WP01

   # Agent B (in parallel!)
   spec-kitty implement WP03

   # Both work in isolated worktrees without conflicts
   ```

   ## Dependencies

   Work package dependencies are declared in frontmatter:
   ```yaml
   dependencies: ["WP01"]  # This WP depends on WP01
   ```

   The implement command reads this field and validates --base flag matches.

   ## Troubleshooting

   **Error: "Base workspace WP01 does not exist"**
   - Solution: Implement WP01 first: `spec-kitty implement WP01`

   **Error: "WP02 has dependencies. Use: spec-kitty implement WP02 --base WP01"**
   - Solution: Add --base flag as suggested

   **Warning: "Base branch has changed. Consider rebasing..."**
   - Solution: Run suggested rebase command (git limitation, fixed in future jj integration)
   ```

3. Include comprehensive examples and troubleshooting

**Files**: `.kittify/missions/software-dev/command-templates/implement.md` (NEW)

**Validation**: After creation, WP02 test `test_implement_template_exists()` should PASS

**Parallel?**: Can create in parallel with T053-T055

---

### Subtask T057 – Run migration tests, verify PASS

**Purpose**: Execute migration tests (from WP02) and verify ALL tests pass after template updates.

**Steps**:
1. Run migration test suite:
   ```bash
   pytest tests/specify_cli/test_workspace_per_wp_migration.py -v
   ```

2. Verify all tests PASS:
   - test_template_directory_exists → PASS
   - test_specify_template_updated → PASS (specify.md updated)
   - test_plan_template_updated → PASS (plan.md updated)
   - test_tasks_template_updated → PASS (tasks.md updated)
   - test_implement_template_exists → PASS (implement.md created)

3. If any test FAILS:
   - Identify which template check failed
   - Review template content (back to T053-T056)
   - Update template to meet test criteria
   - Re-run tests until all pass

**Expected**: All tests PASS (initially they FAILED in WP02, now they should PASS)

**Files**: N/A (test execution)

**Parallel?**: No (validation step after all updates)

---

### Subtask T058 – Add list-legacy-features utility command

**Purpose**: Provide users with command to check for legacy worktrees before upgrading.

**Steps**:
1. Add utility function (can be in implement.py or new utilities.py):
   ```python
   def list_legacy_features() -> None:
       """List legacy worktrees that must be cleaned up before 0.11.0 upgrade."""
       from specify_cli.tasks_support import find_repo_root
       from specify_cli.upgrade.migrations.m_0_11_0_workspace_per_wp import detect_legacy_worktrees
       from rich.console import Console

       console = Console()
       repo_root = find_repo_root()
       legacy = detect_legacy_worktrees(repo_root)

       if not legacy:
           console.print("[green]✓[/green] No legacy worktrees found")
           console.print("Project is ready for 0.11.0 upgrade")
           return

       console.print(f"[yellow]Legacy worktrees found:[/yellow] {len(legacy)}\n")
       for wt in legacy:
           console.print(f"  - {wt.name}")

       console.print("\n[cyan]Action required:[/cyan]")
       console.print("  Complete: spec-kitty merge <feature>")
       console.print("  OR Delete: git worktree remove .worktrees/<feature>")
   ```

2. Register command in CLI router:
   ```python
   app.command(name="list-legacy-features", help="List legacy worktrees blocking 0.11.0 upgrade")(list_legacy_features)
   ```

**Files**: `src/specify_cli/cli/commands/implement.py` or new `utilities.py`

**Usage**:
```bash
spec-kitty list-legacy-features

# Output:
# Legacy worktrees found: 2
#   - 008-unified-python-cli
#   - 009-jujutsu-vcs-integration
#
# Action required:
#   Complete: spec-kitty merge <feature>
#   OR Delete: git worktree remove .worktrees/<feature>
```

**Parallel?**: Can implement in parallel with template updates

---

## Template Update Details

### specify.md Changes

**Remove**:
- Any mention of "Creates .worktrees/###-feature/"
- Navigation instructions to worktree
- Working in worktree context

**Add**:
- "Works in main repository"
- "Creates kitty-specs/###-feature/spec.md"
- "Commits to main branch"
- "Worktrees created later during implement"

### plan.md Changes

**Remove**:
- "Navigate to worktree"
- "cd .worktrees/###-feature"
- Assumptions about being in worktree

**Add**:
- "Works in main repository"
- "Verify you're on main branch"
- "Commits plan.md to main"

### tasks.md Changes

**Add**:
- Dependency detection explanation
- Frontmatter `dependencies:` field generation
- Implementation command documentation (`spec-kitty implement WP## [--base WP##]`)
- Examples showing dependencies in frontmatter

### implement.md (NEW)

**Create new file with**:
- Command syntax and examples
- Dependency handling (--base flag)
- Parallel development explanation
- Workflow overview (planning in main → implement creates worktrees)
- Troubleshooting section

---

## Test Strategy

**Migration Tests** (from WP02): Validate template sources updated

**Test File**: `tests/specify_cli/test_workspace_per_wp_migration.py`

**Execution**:
```bash
pytest tests/specify_cli/test_workspace_per_wp_migration.py -v
```

**What tests check**:
- Template directory exists
- specify.md has no worktree creation, mentions main repo
- plan.md has no worktree navigation, mentions main repo
- tasks.md includes dependency and implement command documentation
- implement.md exists with --base flag docs

**All tests must PASS** - this is the exit criteria for WP07.

---

## Risks & Mitigations

**Risk 1: Template updates don't propagate to users**
- Impact: Users upgrade but don't see new workflow
- Mitigation: Migration guide instructs: "After upgrade, run `spec-kitty init --here` to regenerate agent files"

**Risk 2: Template content incorrect**
- Impact: Generated agent files have wrong instructions
- Mitigation: Migration tests validate content (not just existence), manual review of templates

**Risk 3: Pre-upgrade validation too strict**
- Impact: Blocks legitimate upgrades
- Mitigation: Only block if legacy worktrees actually exist, provide clear cleanup instructions

---

## Definition of Done Checklist

- [ ] Migration file created (T049)
- [ ] Pre-upgrade validation implemented (T050-T052)
- [ ] Template source: specify.md updated (T053)
- [ ] Template source: plan.md updated (T054)
- [ ] Template source: tasks.md updated (T055)
- [ ] Template source: implement.md created (T056)
- [ ] Migration tests PASS (T057)
- [ ] list-legacy-features command created (T058)
- [ ] Manual verification: Check all 4 template files, verify content correct

---

## Review Guidance

**Reviewers should verify**:
1. **Only 4 files updated**: Template sources in `.kittify/missions/software-dev/command-templates/`, not agent directories
2. **Migration tests pass**: Run pytest, verify 100% pass
3. **Pre-upgrade validation works**: Test with legacy worktree present, verify blocks upgrade
4. **Template content correct**: Read each template, verify instructions accurate

**Key Acceptance Checkpoints**:
- Run migration tests: `pytest tests/specify_cli/test_workspace_per_wp_migration.py -v` → ALL PASS
- Read 4 template files, verify workflow instructions match spec.md user stories
- Test pre-upgrade validation: Create fake legacy worktree, run validation, verify blocked

---

## Original WP07 Issues (Documented for Learning)

**Issue 1**: Tried to update 48 agent directory files (T053-T067)
**Issue 2**: Agent directories are gitignored (don't exist in repo)
**Issue 3**: Different agents use different extensions (.md, .toml, .prompt.md) - tests would fail

**Root cause**: Misunderstood template architecture. Templates are SOURCE, agent directories are GENERATED.

**Lesson**: Verify file architecture before designing migration. Check .gitignore, understand generation vs committed files.

**Scope impact**: Reduced from 21 subtasks to 10 subtasks (52% reduction!)

---

## Activity Log

- 2026-01-07T00:00:00Z – system – lane=planned – Prompt created via /spec-kitty.tasks
- 2026-01-08T10:05:00Z – claude – lane=planned – CORRECTED: Template sources (4 files), not agent directories (48 files)

---

### Updating Lane Status

Move this WP between lanes using:
```bash
spec-kitty agent workflow implement WP07
```

Or edit the `lane:` field in frontmatter directly.
- 2026-01-08T10:06:44Z – agent – lane=doing – Started implementation via workflow command
- 2026-01-08T10:15:22Z – unknown – lane=for_review – Ready for review
- 2026-01-08T10:15:54Z – agent – lane=doing – Started review via workflow command
- 2026-01-08T10:21:16Z – unknown – lane=done – Review passed - all tests passing, migration logic verified, templates correctly updated
- 2026-01-11T14:56:36Z – unknown – lane=planned – Critical bug: init uses wrong template directory (.kittify/templates instead of .kittify/missions/software-dev)
- 2026-01-12T14:38:33Z – Codex – shell_pid=80475 – lane=done – Moved to done
