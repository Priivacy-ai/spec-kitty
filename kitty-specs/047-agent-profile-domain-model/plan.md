# Implementation Plan: Agent Profile Domain Model

**Branch**: `develop` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/047-agent-profile-domain-model/spec.md`

## Summary

Introduce `AgentProfile` as a first-class domain entity in spec-kitty 2.x, separating behavioral identity (who an agent IS) from tool configuration (which IDE/CLI is available). The implementation creates a new `src/doctrine/` Python package within the existing `spec-kitty-cli` distribution, containing the profile domain model, specialization hierarchy, profile repository with two-source loading, and a shipped reference profile catalog. In parallel, the existing `AgentConfig` is renamed to `ToolConfig` with alias-first backward compatibility. CLI commands provide profile management.

## Technical Context

**Language/Version**: Python 3.11+ (existing spec-kitty codebase)
**Primary Dependencies**: ruamel.yaml (YAML I/O), typer (CLI), rich (console output), jsonschema (profile validation)
**Storage**: Filesystem — `.agent.yaml` files in `src/doctrine/agents/` (shipped) and `.kittify/constitution/agents/` (project-level)
**Testing**: pytest with 90%+ coverage, mypy --strict, ruff
**Target Platform**: Linux, macOS, Windows 10+ (cross-platform)
**Project Type**: Single distribution — `src/doctrine/` is a subpackage within `spec-kitty-cli`
**Performance Goals**: Profile loading < 200ms for 50 profiles (pure YAML parsing, no AI invocation)
**Constraints**: `src/doctrine/` must have zero imports from `specify_cli` (enforced by CI check)
**Scale/Scope**: 6-10 shipped reference profiles, up to 50 total with project customizations

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| Python 3.11+ | PASS | All new code uses 3.11+ features (StrEnum, `list[str]` syntax) |
| Test-first development (ATDD + TDD) | PASS | Each WP will follow RED-GREEN-REFACTOR per constitution |
| 90%+ test coverage | PASS | Required for all new code in `src/doctrine/` and modified `specify_cli` |
| mypy --strict | PASS | All new modules will have full type annotations |
| Cross-platform | PASS | Pure Python with filesystem operations via pathlib |
| No drive-by refactoring | PASS | ToolConfig rename is in-scope; no other unrelated changes |
| Locality of change | PASS | New `src/doctrine/` package is greenfield; ToolConfig touches only files that import AgentConfig |

## Project Structure

### Documentation (this feature)

```
kitty-specs/047-agent-profile-domain-model/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity definitions and relationships
├── quickstart.md        # Developer quick reference
├── checklists/
│   └── requirements.md  # Specification quality checklist
└── tasks.md             # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── doctrine/                              # NEW: Agent profile domain model package
│   ├── __init__.py                        # Public API exports
│   ├── py.typed                           # PEP 561 marker
│   ├── agents/                            # Shipped reference profiles
│   │   ├── architect.agent.yaml
│   │   ├── implementer.agent.yaml
│   │   ├── reviewer.agent.yaml
│   │   ├── planner.agent.yaml
│   │   ├── researcher.agent.yaml
│   │   └── curator.agent.yaml
│   ├── model/                             # Domain model (frozen dataclasses)
│   │   ├── __init__.py                    # Re-export public types
│   │   ├── profile.py                     # AgentProfile, Specialization, CollaborationContract, ModeDefault
│   │   ├── hierarchy.py                   # SpecializationHierarchy, HierarchyNode, context matching
│   │   └── capabilities.py               # RoleCapabilities, Role enum, canonical verbs
│   ├── repository/                        # Repository services
│   │   ├── __init__.py
│   │   └── profile_repository.py          # AgentProfileRepository (two-source loading)
│   ├── schema/                            # Validation
│   │   └── agent_profile.schema.json      # JSON Schema for .agent.yaml files
│   └── _validation.py                     # Schema validation helpers
│
├── specify_cli/
│   ├── orchestrator/
│   │   ├── tool_config.py                 # RENAMED from agent_config.py (ToolConfig class)
│   │   ├── agent_config.py                # DEPRECATED: re-exports from tool_config.py (alias + deprecation warning)
│   │   └── ...
│   └── cli/commands/
│       └── agent/
│           ├── __init__.py                # MODIFIED: adds profile subcommand
│           └── profile.py                 # NEW: spec-kitty agent profile list|show|create|edit|hierarchy
│
tests/
├── doctrine/                              # NEW: Tests for doctrine package
│   ├── conftest.py                        # Fixtures: sample profiles, tmp directories
│   ├── model/
│   │   ├── test_profile.py                # AgentProfile dataclass, serialization, validation
│   │   ├── test_hierarchy.py              # Hierarchy building, cycle detection, context matching
│   │   └── test_capabilities.py           # Role vocabulary, canonical verbs, conflict detection
│   ├── repository/
│   │   └── test_profile_repository.py     # Two-source loading, merge semantics, queries
│   └── test_schema_validation.py          # JSON Schema validation of .agent.yaml files
├── specify_cli/
│   ├── orchestrator/
│   │   └── test_tool_config.py            # NEW: ToolConfig rename, backward compat, alias
│   └── cli/commands/agent/
│       └── test_profile_cli.py            # NEW: CLI profile commands
└── test_doctrine_import_boundary.py       # CI boundary check: doctrine has zero specify_cli imports
```

### Key Design Decisions

1. **Frozen dataclasses** — `AgentProfile`, `Specialization`, `CollaborationContract`, `SpecializationContext`, `ModeDefault` are all `@dataclass(frozen=True)` with manual `to_dict()`/`from_dict()` classmethods, following the status model pattern from feature 034.

2. **StrEnum for controlled vocabularies** — `Role` enum uses `StrEnum` for the controlled vocabulary (`implementer`, `reviewer`, `architect`, etc.) with a catch-all for custom roles via string validation.

3. **Two-source repository** — `AgentProfileRepository` loads shipped profiles from `src/doctrine/agents/` using `importlib.resources` (for packaged distribution), then overlays project-level profiles from `.kittify/constitution/agents/`. Field-level merge: project values replace shipped values per-field, not whole-object replacement.

4. **Alias-first rename** — Create `tool_config.py` with `ToolConfig` class, then create `agent_config.py` as a deprecated alias module that re-exports everything. Update imports iteratively, tests green at each step.

5. **JSON Schema for validation** — A static `agent_profile.schema.json` file in `src/doctrine/schema/` validated via `jsonschema` (already a dependency). Used by both the repository loader and the CLI `create` command.

6. **Package distribution** — `src/doctrine/` added to `pyproject.toml` `packages` list alongside `src/specify_cli`. Single `pip install spec-kitty-cli` installs both. Import boundary enforced by a CI test that greps for `from specify_cli` or `import specify_cli` in `src/doctrine/`.

### Dependency Graph (Work Package Order)

```
WP01: Package scaffolding + boundary test
  │
  ├──► WP02: Domain model (profile.py, capabilities.py)
  │      │
  │      ├──► WP03: Hierarchy model + context matching
  │      │
  │      ├──► WP04: Repository (two-source loading, merge)
  │      │      │
  │      │      └──► WP06: Reference profile catalog
  │      │
  │      └──► WP05: JSON Schema + validation
  │
  ├──► WP07: ToolConfig rename (alias-first, iterative cleanup)
  │
  └──► WP08: CLI profile commands (depends on WP04 repository)
```

### ToolConfig Rename Strategy

The rename follows an alias-first approach:

**Step 1** (within WP07): Create `tool_config.py` by copying `agent_config.py` and renaming:

- `AgentConfig` → `ToolConfig`
- `AgentSelectionConfig` → `ToolSelectionConfig`
- `AgentConfigError` → `ToolConfigError`
- `load_agent_config` → `load_tool_config`
- `save_agent_config` → `save_tool_config`
- `get_configured_agents` → `get_configured_tools`

**Step 2** (within WP07): Replace `agent_config.py` with a thin alias module:

```python
"""DEPRECATED: Use tool_config instead. This module will be removed in a future version."""
import warnings
from specify_cli.orchestrator.tool_config import *  # noqa: F401,F403
from specify_cli.orchestrator.tool_config import (
    ToolConfig as AgentConfig,
    ToolSelectionConfig as AgentSelectionConfig,
    ToolConfigError as AgentConfigError,
    load_tool_config as load_agent_config,
    save_tool_config as save_agent_config,
    get_configured_tools as get_configured_agents,
)
warnings.warn("agent_config is deprecated, use tool_config", DeprecationWarning, stacklevel=2)
```

**Step 3** (within WP07): Update all 7 importing files to use `tool_config`, ensuring tests pass after each file update.

**Step 4** (within WP07): Update `config.yaml` reader to check `tools:` key first, fall back to `agents:` with deprecation log.

### Import Boundary Enforcement

A dedicated test (`tests/test_doctrine_import_boundary.py`) will:

1. Walk all `.py` files under `src/doctrine/`
2. Assert none contain `from specify_cli` or `import specify_cli`
3. This test runs in CI and catches accidental coupling

## Complexity Tracking

No constitution violations. The new `src/doctrine/` package is justified by the ADR decision (separation of concerns, zero-import boundary). The repository pattern is justified by the two-source loading requirement (shipped + project profiles with merge semantics).
