# Implementation Plan: Local Mission Dossier Authority & Parity Export

**Feature Branch**: `042-local-mission-dossier-authority-parity-export`
**Date**: 2026-02-21 | **Spec**: `/kitty-specs/042-local-mission-dossier-authority-parity-export/spec.md`

## Summary

Implement a mission artifact dossier system that indexes all spec-kitty feature artifacts, computes deterministic content hashes and parity signatures, and emits canonical dossier events to sync infrastructure. Local runtime performs parity-drift detection offline; SaaS backend receives events for dashboard rendering and parity validation. Phase 1 (this feature) delivers:

- **Core Indexing**: ArtifactRef model, deterministic SHA256 hashing, MissionDossier data model
- **Expected Artifacts**: Registry of required/optional artifacts per mission type (software-dev, research, documentation)
- **Dossier Events**: 4 canonical event types (Indexed, Missing, Computed, ParityDrift) integrated with sync infrastructure
- **Dashboard API**: Endpoints for overview, list, filter, detail, export
- **Local UI**: Dashboard dossier panel with filtering and artifact detail views
- **Parity Detection**: Local drift detection comparing current snapshot vs cached baseline

Deterministic design ensures identical artifact content always produces identical parity hash, enabling reliable SaaS parity validation.

## Technical Context

**Language/Version**: Python 3.11+ (existing spec-kitty codebase requirement)
**Primary Dependencies**:
  - `hashlib` (SHA256, stdlib)
  - `pydantic` (data validation, existing spec-kitty dependency)
  - `rich` (console output, existing)
  - `ruamel.yaml` (YAML parsing for mission manifests)
  - `spec_kitty_events` (sync infrastructure, existing)
  - `http.server.HTTPServer` (stdlib, existing dashboard server)
  - Static JavaScript (dashboard UI, existing)

**Storage**: Filesystem only (YAML configs, JSON event logs, markdown artifacts)
**Testing**: `pytest` + `pytest-asyncio` (for async API tests)
**Target Platform**: Linux/macOS/Windows (CLI + local HTTP server)
**Project Type**: Single Python package (spec-kitty CLI) + dashboard Vue plugin
**Performance Goals**:
  - Artifact indexing: <1s for 30 artifacts
  - API responses: <500ms for full catalog (SC-001)
  - Parity hash computation: deterministic, reproducible (SC-006, SC-007)

**Constraints**:
  - No external service calls during local indexing (offline-capable)
  - Deterministic hashing (identical content → identical hash across machines/timezones)
  - UTF-8 robustness (consistent handling of encoding edge cases)
  - No silent failures (all anomalies explicit in events)

**Scale/Scope**:
  - Support >1000 artifacts per feature (SC-005)
  - 3 mission types with manifests in v1 (software-dev, research, documentation)
  - 6 artifact classes (input, workflow, output, evidence, policy, runtime) – deterministic, no fallback
  - 4 dossier event types (Indexed, Missing, Computed, ParityDrift) – anomaly events conditional

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Filesystem-Only Storage**: No new database tables required. Dossier state persists as JSONL event log and JSON snapshots in feature directory.

✅ **No Breaking Changes to Existing Models**: Feature introduces new dossier-specific entities (ArtifactRef, MissionDossier, etc.), does not modify existing mission/feature models.

✅ **Sync Infrastructure Integration**: Uses existing spec_kitty_events contracts and OfflineQueue. Adds 4 new event types (Dossier*) to schema, backward-compatible.

✅ **Dashboard Server Already Exists**: FastAPI server and Vue frontend for dashboard already deployed. Dossier panel is a new Vue component, reuses existing API middleware.

✅ **Async OK for API Endpoints**: Feature uses FastAPI's async/await for dashboard endpoints. Existing dashboard already uses async patterns, consistent with codebase.

✅ **Third-Party Dependencies**: All required dependencies already vendored (pydantic, ruamel.yaml, fastapi, rich). No new external packages required.

✅ **Mission Agnostic Foundation**: Dossier system is mission-agnostic; manifests are extensible per mission type. V1 ships strict manifests only for 3 missions, others degrade gracefully.

**Gates Passed**: All constitutional gates green. Proceeding to Phase 1 design.

## Project Structure

### Documentation (this feature)

```
kitty-specs/042-local-mission-dossier-authority-parity-export/
├── spec.md              # Feature specification (source of truth)
├── plan.md              # This file (technical design)
├── research.md          # Phase 0 research (TBD by /spec-kitty.plan)
├── data-model.md        # Phase 1 data model (TBD by /spec-kitty.plan)
├── quickstart.md        # Phase 1 quickstart (TBD by /spec-kitty.plan)
├── contracts/           # Phase 1 JSON Schema contracts (TBD by /spec-kitty.plan)
└── tasks.md             # Phase 2 work packages (generated by /spec-kitty.tasks)
```

### Source Code Structure

```
src/specify_cli/
├── dossier/                          # NEW: Dossier subsystem
│   ├── __init__.py
│   ├── models.py                     # ArtifactRef, MissionDossier, MissionDossierSnapshot
│   ├── manifest.py                   # ExpectedArtifactManifest, registry per mission type
│   ├── indexer.py                    # Artifact indexing, hashing, missing detection
│   ├── hasher.py                     # Deterministic SHA256 hashing, parity computation
│   ├── events.py                     # Dossier event emission (4 types)
│   ├── store.py                      # Snapshot persistence (JSON JSONL)
│   ├── drift_detector.py             # Local parity-drift detection
│   └── test_fixtures.py              # Shared test helpers
│
├── dashboard/
│   ├── handlers/
│   │   ├── api.py                    # MODIFY: Add dossier API handler methods
│   │   │   ├── handle_dossier_overview()
│   │   │   ├── handle_dossier_artifacts()
│   │   │   ├── handle_dossier_artifact_detail()
│   │   │   └── handle_dossier_snapshot_export()
│   │   └── router.py                 # MODIFY: Add routing for /api/dossier/*
│   │
│   ├── static/
│   │   └── js/
│   │       └── dossier-panel.js      # NEW: Dossier UI (fetch + DOM updates)
│   │
│   └── scanner.py                    # MODIFY: Integrate dossier scanner callback
│
├── missions/
│   ├── software-dev/
│   │   └── expected-artifacts.yaml   # NEW: Manifest for software-dev mission artifacts
│   ├── research/
│   │   └── expected-artifacts.yaml   # NEW: Manifest for research mission artifacts
│   └── documentation/
│       └── expected-artifacts.yaml   # NEW: Manifest for documentation mission artifacts
│
└── sync/
    └── events.py                     # MODIFY: Register 4 new dossier event types

tests/
├── specify_cli/dossier/              # NEW: Dossier test suite
│   ├── test_models.py
│   ├── test_manifest.py
│   ├── test_indexer.py
│   ├── test_hasher.py
│   ├── test_events.py
│   ├── test_drift_detector.py
│   └── integration/
│       ├── test_determinism.py       # Hash reproducibility
│       ├── test_missing_detection.py # All 4 event types
│       └── test_encoding.py          # UTF-8 edge cases
│
└── integration/
    ├── test_dashboard_dossier.py     # Dashboard API integration
    └── test_sync_dossier.py          # Sync pipeline integration
```

**Structure Decision**: Single Python package (spec-kitty) + optional frontend Vue components. Dossier subsystem is self-contained in `src/specify_cli/dossier/`, integrates with dashboard API and sync infrastructure via extension points (not modification of core).

## Phase Breakdown & Work Packages

### Phase 1: Core Projection & Events (WP01-WP05)

| WP | Title | Deliverables | Dependencies |
|----|-------|--------------|--------------|
| **WP01** | ArtifactRef Model & Deterministic Hashing | `models.py` + hasher.py with SHA256 logic | None |
| **WP02** | Expected Artifact Manifests | 3 YAML manifests (software-dev, research, documentation) in `missions/*/` | None |
| **WP03** | Indexing & Missing Detection | `indexer.py` + manifest-based validation | WP01, WP02 |
| **WP04** | Dossier Event Types & Emit Integration | `events.py` + 4 event schemas in contracts/ | WP01, WP03 |
| **WP05** | Deterministic Snapshot & Parity Hash | Snapshot computation, store.py, reproduce on identical content | WP01, WP04 |

### Phase 2: API & Dashboard (WP06-WP08)

| WP | Title | Deliverables | Dependencies |
|----|-------|--------------|--------------|
| **WP06** | Dashboard API Endpoints | 4 FastAPI routes (overview, list, detail, export) | WP01-WP05 |
| **WP07** | Dashboard UI Integration | DossierPanel.vue + ArtifactDetail.vue + filtering | WP06 |
| **WP08** | Local Parity-Drift Detector | `drift_detector.py`, local baseline cache, event emission | WP05, WP06 |

### Phase 3: Testing & Hardening (WP09-WP10)

| WP | Title | Deliverables | Dependencies |
|----|-------|--------------|--------------|
| **WP09** | Determinism Test Suite | Hash reproducibility, ordering stability, encoding tests | All Phase 1 |
| **WP10** | Integration & Edge Cases | Dashboard API tests, sync pipeline integration, large artifacts, encoding errors | All Phase 2 + WP09 |

## Key Technical Decisions

### 1. **Deterministic Hashing**
- Use SHA256 (hashlib, stdlib)
- Hash artifact bytes directly (not relative path or metadata)
- Order-independent parity: sort hashes before combining, compute combined hash
- Encoding: Read as binary, fail explicitly if invalid UTF-8 (no silent fallback)

### 2. **Manifest System**
- YAML per mission type: `src/specify_cli/missions/{mission}/expected-artifacts.yaml`
- Schema:
  ```yaml
  required_by_step:
    planning: [spec, plan, tasks, tasks/*.md]
    implementation: [...]
  optional_always: [research, gap-analysis]
  ```
- Extensible: Other missions degrade gracefully (no manifest = no missing detection, only indexing)

### 3. **Artifact Classification**
- 7 classes: input, workflow, output, evidence, policy, runtime, + extensible
- Derived from filename patterns or explicit frontmatter (if added to mission templates)
- Used for filtering in dashboard

### 4. **Event Emission (Conditional & Deterministic)**
- Integrated with spec_kitty_events contracts
- **Always Emitted**: MissionDossierArtifactIndexed (one per artifact), MissionDossierSnapshotComputed (after scan completes)
- **Conditionally Emitted**: MissionDossierArtifactMissing (only if required artifacts missing), MissionDossierParityDriftDetected (only if local hash differs from baseline)
- Routed via OfflineQueue (async, retry-safe)
- Each event immutable, timestamped, includes envelope metadata

### 5. **Local Parity Detection**
- Baseline: locally cached last-known parity hash per feature (stored in .kittify/dossiers/{feature_slug}/parity-baseline.json)
- **Feature Namespacing**: Each feature has its own baseline directory to prevent cross-feature contamination
- Compare current snapshot hash vs cached baseline for that feature
- Emit MissionDossierParityDriftDetected only if hash differs
- Works offline: no SaaS call required

### 6. **Dashboard API Design**
- Stateless endpoints, no session required
- Filtering by class, wp_id, step_id with stable ordering
- Detail endpoint returns full text (with truncation notice for >5MB)
- Export endpoint returns snapshot JSON (importable by SaaS)

### 7. **Completeness Phases & Manifest Scoping**
- **Phase 1 (Spec Phase - Immediate)**: Requires `spec.md` only (after /spec-kitty.specify)
- **Phase 2 (Planning Phase - After /spec-kitty.plan)**: Requires `spec.md`, `plan.md` (optional: research.md, data-model.md, contracts/)
- **Phase 3 (Tasks Phase - After /spec-kitty.tasks)**: Requires all Phase 2 artifacts + `tasks.md`, `tasks/*.md`
- **Manifest Design**: `required_by_step` keys are phase identifiers (spec_complete, planning_complete, tasks_complete) so completeness can be checked at any point in the workflow
- Optional artifacts (research.md, etc.): indexed if present, ignored if absent, never block completeness

### 8. **Error Handling**
- No silent failures: all anomalies explicit in events and API
- Unreadable artifacts: emit MissionDossierArtifactMissing with reason_code="unreadable"
- UTF-8 errors: record hash error, include in anomaly event, continue scan
- Missing required artifacts for current phase: blocking anomaly (completeness_status="incomplete")
- Missing optional artifacts: non-blocking, recorded, not counted as missing

## Out-of-Scope (Defer to Future Features)

1. SaaS dashboard UI (local dashboard only in Phase 1)
2. Event replay/theater workflows (emit-only this phase)
3. Full-text search indexing (basic filtering only)
4. Real-time artifact sync (batch scan-based)
5. Artifact versioning or delta tracking (snapshot-based)