# Work Packages: Constitution Parser and Structured Config

**Inputs**: Design documents from `kitty-specs/045-constitution-doctrine-config-sync/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Included in each WP — TDD per constitution requirement (90%+ coverage, mypy --strict).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Parser and Schemas (Priority: P0)

**Goal**: Create the `constitution/` subpackage with the deterministic markdown parser and Pydantic output schemas. This is the foundation all other WPs depend on.
**Independent Test**: Parse the existing constitution at `.kittify/memory/constitution.md` and produce `ConstitutionSection` objects. Validate Pydantic models accept/reject correct/incorrect data.
**Prompt**: `tasks/WP01-parser-and-schemas.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T001 [P] Create `src/specify_cli/constitution/` subpackage skeleton (`__init__.py`, module stubs)
- [ ] T002 Implement `ConstitutionParser` — section splitter (heading-based markdown splitting)
- [ ] T003 Implement markdown table parser → dict extraction
- [ ] T004 [P] Implement YAML code block parser → dict extraction
- [ ] T005 [P] Implement numbered list parser → list extraction
- [ ] T006 Implement keyword/number extraction for prose patterns (e.g., "90% coverage" → `{min_coverage: 90}`)
- [ ] T007 Define `GovernanceConfig` Pydantic model with nested `TestingConfig`, `QualityConfig`, `PerformanceConfig`, `BranchStrategyConfig`
- [ ] T008 [P] Define `AgentsConfig` + `AgentProfile` Pydantic models
- [ ] T009 [P] Define `DirectivesConfig` + `Directive` Pydantic models
- [ ] T010 Define `ExtractionMetadata` Pydantic model
- [ ] T011 [P] Implement YAML emission helpers (header comment, ordered key output)
- [ ] T012 Write parser + schema unit tests

### Implementation Notes
- Parser uses Python `re` module — no external markdown library needed (per research.md RQ-1)
- Split constitution on `^## ` headings, then parse each section's content type
- Pydantic models define defaults for all fields (data-model.md has the full schema)
- YAML emission uses ruamel.yaml with `# Auto-generated from constitution.md` header

### Parallel Opportunities
- T004, T005 (YAML block + numbered list parsers) are independent of T003 (table parser)
- T008, T009 (agent + directive schemas) are independent of T007 (governance schema)
- T011 (YAML emission) can proceed once any schema is defined

### Dependencies
- None (starting package).

### Risks & Mitigations
- Risk: Regex parsing fragile for edge cases → Mitigate with comprehensive test fixtures from real constitutions
- Risk: Schema too rigid for diverse constitutions → Use generous defaults and Optional fields

---

## Work Package WP02: Extraction Pipeline (Priority: P0)

**Goal**: Implement the `Extractor` that maps parsed constitution sections to validated Pydantic models and emits YAML files. Includes AI fallback interface.
**Independent Test**: Feed a parsed constitution through the extractor, verify governance.yaml contains correct values. Verify AI fallback is invoked for prose-only sections.
**Prompt**: `tasks/WP02-extraction-pipeline.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T013 Implement `Extractor` class — deterministic pipeline (parse → map → validate → emit)
- [ ] T014 Implement section-to-schema mapping (constitution heading keywords → target YAML fields)
- [ ] T015 Implement merge logic for multi-section extraction (e.g., testing info scattered across sections)
- [ ] T016 [P] Implement AI fallback interface (prompt template for prose sections + subprocess invocation stub)
- [ ] T017 Implement YAML file writer (emit validated Pydantic models to `.kittify/constitution/*.yaml`)
- [ ] T018 Write extractor unit + integration tests

### Implementation Notes
- Section mapping uses keyword matching: "testing" → `governance.testing`, "quality" → `governance.quality`, etc.
- AI fallback: build structured prompt with schema fields + prose text, parse YAML response
- If AI unavailable: skip prose sections, set `extraction_mode: "deterministic"` in metadata
- YAML writer calls `model.model_dump()` → `ruamel.yaml.dump()` with header comment

### Parallel Opportunities
- T016 (AI fallback interface) is independent of T013-T015 (deterministic pipeline)

### Dependencies
- Depends on WP01 (parser and schemas).

### Risks & Mitigations
- Risk: Section keyword mapping misidentifies sections → Use ranked keyword matching with minimum confidence
- Risk: AI fallback response doesn't match schema → Validate with Pydantic, fall back to empty defaults

---

## Work Package WP03: Sync, Hashing, and CLI Commands (Priority: P0)

**Goal**: Implement the sync orchestration (`hash check → extract → write`), content hashing for staleness detection, and `spec-kitty constitution sync|status` CLI commands.
**Independent Test**: Run `spec-kitty constitution sync` with a constitution file, verify YAML files appear in `.kittify/constitution/`. Run `spec-kitty constitution status` and verify correct output.
**Prompt**: `tasks/WP03-sync-hashing-cli.md`
**Estimated Size**: ~420 lines

### Included Subtasks
- [ ] T019 Implement `hasher.py` — SHA-256 content hashing with whitespace normalization
- [ ] T020 Implement staleness detection — compare file hash vs metadata.yaml hash
- [ ] T021 Implement `sync.py` — orchestration function (read constitution → parse → extract → write YAML → update metadata)
- [ ] T022 Implement `spec-kitty constitution sync` CLI command (Typer)
- [ ] T023 Implement `spec-kitty constitution status` CLI command (Rich table output)
- [ ] T024 Register constitution subcommand in CLI app
- [ ] T025 Write sync + hashing + CLI tests

### Implementation Notes
- Hash function: `sha256:{hex}` format (per research.md RQ-3)
- `sync()` is idempotent — same input → same output (FR-1.6)
- `status` command: show last sync time, hash match (synced/stale), list YAML files (FR-5.3)
- CLI registration follows same pattern as `agent telemetry` subcommand

### Parallel Opportunities
- T19-T20 (hashing) and T22-T23 (CLI commands) can be developed in parallel once sync is stubbed

### Dependencies
- Depends on WP02 (extractor pipeline).

### Risks & Mitigations
- Risk: Hash mismatch on whitespace-only changes → Normalize whitespace before hashing
- Risk: CLI command registration conflicts → Follow established telemetry CLI pattern

---

## Work Package WP04: Constitution Directory Migration (Priority: P1)

**Goal**: Create upgrade migration that moves constitution from `.kittify/memory/constitution.md` to `.kittify/constitution/constitution.md` and updates all internal code references.
**Independent Test**: Create a project with constitution at old path. Run migration. Verify file moved, YAML extraction triggered, all code references point to new path.
**Prompt**: `tasks/WP04-migration.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T026 Create migration `m_0_XX_0_constitution_directory.py` — move file + create directory
- [x] T027 Update `src/specify_cli/dashboard/handlers/api.py` — constitution path
- [x] T028 Update `src/specify_cli/core/worktree.py` — symlink path
- [x] T029 Update `src/specify_cli/cli/commands/init.py` — directory comment
- [x] T030 Update constitution command template path references
- [x] T031 [P] Trigger initial sync during migration (with graceful fallback if AI unavailable — FR-3.4)
- [x] T032 Write migration tests (parametrized across scenarios: old path exists, new path exists, no constitution)

### Implementation Notes
- Migration number: next available after existing migrations (check `src/specify_cli/upgrade/migrations/`)
- Must handle all 3 scenarios: old path → move, new path already exists → skip, no constitution → skip
- Dashboard API update: change `constitution_path` to `.kittify/constitution/constitution.md`
- Worktree update: symlink `.kittify/constitution/` instead of `.kittify/memory/`
- Initial sync: call `sync()` after moving file, catch exceptions (FR-3.4)

### Parallel Opportunities
- T027-T030 (reference updates) are independent of each other
- T031 (initial sync trigger) can proceed once sync() from WP03 is available

### Dependencies
- Depends on WP03 (sync function needed for initial extraction during migration).

### Risks & Mitigations
- Risk: Breaking existing projects that rely on old path → Migration is idempotent, handles all edge cases
- Risk: Missing a code reference → research.md RQ-4 lists all 6 references exhaustively

---

## Work Package WP05: Post-Save Hook and Integration (Priority: P1)

**Goal**: Wire the post-save hook into CLI constitution writes, finalize public API exports, and ensure end-to-end flow works (constitution edit → auto-extraction → governance reads YAML).
**Independent Test**: Run `/spec-kitty.constitution` flow, verify YAML files auto-generated. Load governance config via Python API, verify correct values.
**Prompt**: `tasks/WP05-post-save-hook-integration.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T033 Implement post-save hook function — call sync() after CLI constitution writes
- [x] T034 Wire hook into constitution command template write path
- [x] T035 Implement `load_governance_config()` convenience function for Feature 044 consumers
- [x] T036 Implement `load_agents_config()` convenience function for Feature 046 consumers
- [x] T037 [P] Finalize `constitution/__init__.py` public API exports
- [x] T038 Write integration tests (end-to-end: write constitution → verify YAML → load config)

### Implementation Notes
- Post-save hook: synchronous Python call after write (per AD-4)
- If extraction fails, log warning, leave previous YAML intact (FR-2.3)
- `load_governance_config(repo_root)` → returns `GovernanceConfig` Pydantic model
- Public API: `from specify_cli.constitution import sync, load_governance_config, load_agents_config`
- The hook fires after constitution.md writes in the CLI — not in agent command templates

### Parallel Opportunities
- T035, T036 (convenience loaders) are independent of T033-T034 (hook wiring)
- T037 (exports) can proceed once all modules exist

### Dependencies
- Depends on WP03 (sync function) and WP04 (migration ensures new path is canonical).

### Risks & Mitigations
- Risk: Post-save hook adds latency to constitution writes → Deterministic extraction is <500ms (acceptable)
- Risk: Circular import with constitution → sync → extractor → schemas → Use lazy imports if needed

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02 → WP03 → WP04 + WP05 (WP04 and WP05 can partially parallelize)
- **Parallelization**: WP04 and WP05 can run in parallel once WP03 is complete (they both depend on WP03 but not on each other)
- **MVP Scope**: WP01 + WP02 + WP03 = core extraction + CLI commands (sufficient for `spec-kitty constitution sync`)
- **Full Scope**: All 5 WPs = migration + auto-extraction + governance integration

```
WP01 (Parser + Schemas)
  ↓
WP02 (Extractor Pipeline)
  ↓
WP03 (Sync + CLI)
  ↓
WP04 (Migration)     WP05 (Post-save + Integration)
  ↘                   ↙
    Both depend on WP03
    Can parallelize
```

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create constitution/ subpackage skeleton | WP01 | P0 | Yes |
| T002 | ConstitutionParser — section splitter | WP01 | P0 | No |
| T003 | Markdown table parser | WP01 | P0 | No |
| T004 | YAML code block parser | WP01 | P0 | Yes |
| T005 | Numbered list parser | WP01 | P0 | Yes |
| T006 | Keyword/number extraction | WP01 | P0 | No |
| T007 | GovernanceConfig Pydantic model | WP01 | P0 | No |
| T008 | AgentsConfig + AgentProfile models | WP01 | P0 | Yes |
| T009 | DirectivesConfig + Directive models | WP01 | P0 | Yes |
| T010 | ExtractionMetadata model | WP01 | P0 | No |
| T011 | YAML emission helpers | WP01 | P0 | Yes |
| T012 | Parser + schema tests | WP01 | P0 | No |
| T013 | Extractor class — deterministic pipeline | WP02 | P0 | No |
| T014 | Section-to-schema mapping | WP02 | P0 | No |
| T015 | Merge logic for multi-section extraction | WP02 | P0 | No |
| T016 | AI fallback interface | WP02 | P0 | Yes |
| T017 | YAML file writer | WP02 | P0 | No |
| T018 | Extractor tests | WP02 | P0 | No |
| T019 | SHA-256 content hashing | WP03 | P0 | No |
| T020 | Staleness detection | WP03 | P0 | No |
| T021 | sync() orchestration function | WP03 | P0 | No |
| T022 | `constitution sync` CLI command | WP03 | P0 | No |
| T023 | `constitution status` CLI command | WP03 | P0 | No |
| T024 | CLI subcommand registration | WP03 | P0 | No |
| T025 | Sync + hashing + CLI tests | WP03 | P0 | No |
| T026 | Migration — move file + create directory | WP04 | P1 | No |
| T027 | Update dashboard API path | WP04 | P1 | Yes |
| T028 | Update worktree symlink path | WP04 | P1 | Yes |
| T029 | Update init.py directory comment | WP04 | P1 | Yes |
| T030 | Update command template path references | WP04 | P1 | Yes |
| T031 | Trigger initial sync during migration | WP04 | P1 | Yes |
| T032 | Migration tests | WP04 | P1 | No |
| T033 | Post-save hook function | WP05 | P1 | No |
| T034 | Wire hook into constitution write path | WP05 | P1 | No |
| T035 | load_governance_config() convenience function | WP05 | P1 | Yes |
| T036 | load_agents_config() convenience function | WP05 | P1 | Yes |
| T037 | Finalize __init__.py public API exports | WP05 | P1 | Yes |
| T038 | Integration tests | WP05 | P1 | No |

---

> All placeholder text replaced with feature-specific content. Task structure supports downstream automation and work package parsing.

<!-- status-model:start -->
## Canonical Status (Generated)
- WP01: done
- WP02: done
- WP03: done
- WP04: done
- WP05: done
<!-- status-model:end -->
