# Work Packages: Full-Lifecycle Telemetry Events

**Inputs**: Design documents from `kitty-specs/048-full-lifecycle-telemetry-events/`
**Prerequisites**: plan.md (required), spec.md (user stories)

**Tests**: Constitution requires test-first (ATDD + TDD). Tests included per WP.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Telemetry Emit CLI Command + Cost Grouping (Priority: P1) ðŸŽ¯ MVP

**Goal**: Add the generic `spec-kitty agent telemetry emit` CLI command and extend `cost_summary()` with `group_by="role"`. This is the core building block that all template updates depend on.
**Independent Test**: Run `spec-kitty agent telemetry emit --feature 048-full-lifecycle-telemetry-events --role specifier --agent claude` and verify an event appears in the JSONL file. Run `spec-kitty agent telemetry cost --group-by role` and verify role-based grouping works.
**Prompt**: `tasks/WP01-emit-command-and-cost-grouping.md`

### Included Subtasks

- [x] T001 Add `emit` subcommand to `src/specify_cli/cli/commands/agent/telemetry.py`
- [x] T002 Add `group_by="role"` support to `src/specify_cli/telemetry/cost.py`
- [x] T003 Add "role" to `click.Choice` in the cost CLI command
- [x] T004 Remove `if agent and model` gate in `src/specify_cli/cli/commands/agent/feature.py`
- [x] T005 Remove `if agent and model` gate in `src/specify_cli/cli/commands/agent/workflow.py`
- [x] T006 Write unit tests for emit CLI command
- [x] T007 Write unit tests for `group_by="role"` cost aggregation
- [x] T008 Write tests for always-emit behavior (no --agent/--model flags)

### Implementation Notes

- The `emit` command is a thin wrapper around `emit_execution_event()` from `src/specify_cli/telemetry/emit.py`
- Feature directory is resolved from `kitty-specs/<feature>/` relative to repo root
- The command must always exit 0 (fire-and-forget) â€” catch all exceptions internally
- For the always-emit change: replace `if agent and model:` with unconditional emission, defaulting agent to `"unknown"` when not provided

### Parallel Opportunities

- T001 (emit command) and T002-T003 (cost grouping) can be developed in parallel
- T004 and T005 (gate removal) are independent of each other

### Dependencies

- None (starting package)

### Risks & Mitigations

- Existing tests may assert the `if agent and model` gate behavior â†’ update those tests (T008)
- Fire-and-forget must not swallow errors silently in tests â†’ use logging assertions

---

## Work Package WP02: Slash Command Template Updates (Priority: P1)

**Goal**: Update all 5 relevant slash command templates to include a telemetry emit step as their final instruction. Create the migration to propagate updates to all configured agents.
**Independent Test**: Read each updated template and verify the telemetry emit section exists. Run the migration on a test project and verify templates are copied to configured agents.
**Prompt**: `tasks/WP02-template-updates-and-migration.md`

### Included Subtasks

- [x] T009 Update `src/specify_cli/missions/software-dev/command-templates/specify.md` â€” add telemetry emit section
- [x] T010 [P] Update `src/specify_cli/missions/software-dev/command-templates/plan.md` â€” add telemetry emit section
- [x] T011 [P] Update `src/specify_cli/missions/software-dev/command-templates/tasks.md` â€” add telemetry emit section
- [x] T012 [P] Update `src/specify_cli/missions/software-dev/command-templates/review.md` â€” add telemetry emit section
- [x] T013 [P] Update `src/specify_cli/missions/software-dev/command-templates/merge.md` â€” add telemetry emit section
- [x] T014 Create migration to propagate template updates to all configured agents
- [x] T015 Write migration tests (parametrized across agents)

### Implementation Notes

- Each template gets a new `## Telemetry` section at the end with the emit command pattern
- The emit step instructs the agent to call: `spec-kitty agent telemetry emit --feature <slug> --role <role> --agent <name> --model <model>`
- Include guidance for optional flags (`--input-tokens`, `--output-tokens`, `--cost-usd`, `--duration-ms`)
- Migration must use `get_agent_dirs_for_project()` (config-aware, per CLAUDE.md)
- Migration file naming: follow existing convention in `src/specify_cli/upgrade/migrations/`

### Parallel Opportunities

- T009-T013 (template updates) are all independent â€” can be done in parallel
- T014-T015 (migration) depend on templates being finalized

### Dependencies

- Depends on WP01 (emit command must exist before templates reference it)

### Risks & Mitigations

- Templates are large markdown files â€” careful editing needed to avoid breaking existing content
- Migration must not recreate agent directories that were deliberately removed (use `if not agent_dir.exists(): continue`)

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02
- **Parallelization**: WP01 subtasks (emit command vs cost grouping vs gate removal) can run in parallel within the WP. WP02 template edits are all parallel.
- **MVP Scope**: WP01 alone provides the emit command and cost grouping â€” usable immediately via manual CLI calls. WP02 makes it automatic via templates.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add `emit` subcommand to telemetry CLI | WP01 | P1 | No |
| T002 | Add `group_by="role"` to cost_summary() | WP01 | P1 | Yes |
| T003 | Add "role" to click.Choice in cost CLI | WP01 | P1 | Yes |
| T004 | Remove `if agent and model` gate in feature.py | WP01 | P1 | Yes |
| T005 | Remove `if agent and model` gate in workflow.py | WP01 | P1 | Yes |
| T006 | Unit tests for emit CLI command | WP01 | P1 | No |
| T007 | Unit tests for group_by="role" | WP01 | P1 | Yes |
| T008 | Tests for always-emit behavior | WP01 | P1 | Yes |
| T009 | Update specify.md template | WP02 | P1 | Yes |
| T010 | Update plan.md template | WP02 | P1 | Yes |
| T011 | Update tasks.md template | WP02 | P1 | Yes |
| T012 | Update review.md template | WP02 | P1 | Yes |
| T013 | Update merge.md template | WP02 | P1 | Yes |
| T014 | Create migration for template propagation | WP02 | P1 | No |
| T015 | Write migration tests | WP02 | P1 | No |

<!-- status-model:start -->
## Canonical Status (Generated)

- WP01: done
- WP02: done
<!-- status-model:end -->
