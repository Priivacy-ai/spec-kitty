# Work Packages: Adversarial Test Suite for 0.13.0

**Inputs**: Design documents from `/kitty-specs/024-adversarial-test-suite-0-13-0/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Test Infrastructure & Fixtures (Priority: P0)

**Goal**: Establish adversarial test directory structure and shared fixtures.
**Independent Test**: `pytest tests/adversarial/ --collect-only` successfully discovers test structure.
**Prompt**: `/tasks/WP01-test-infrastructure.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T001 Create `tests/adversarial/__init__.py` with module docstring
- [ ] T002 Create `tests/adversarial/conftest.py` with shared fixtures
- [ ] T003 Define `PATH_ATTACK_VECTORS` data structure in conftest
- [ ] T004 Define `CSV_ATTACK_VECTORS` data structure in conftest
- [ ] T005 Create `symlink_factory` fixture with platform detection
- [ ] T006 Create `adversarial_env` fixture (no SPEC_KITTY_TEMPLATE_ROOT)
- [ ] T007 Register pytest markers in `pyproject.toml`

### Implementation Notes
- All fixtures should be session-scoped where appropriate for performance
- Use `pytest.param` with `id` for readable parametrized test output
- Include skip conditions for platform-specific tests

### Parallel Opportunities
- T003-T006 can proceed in parallel (independent fixture definitions)

### Dependencies
- None (foundation package)

### Risks & Mitigations
- Platform detection edge cases â†’ Test on CI matrix (Linux, macOS)

---

## Work Package WP02: Distribution Tests (Priority: P1) ðŸŽ¯ MVP

**Goal**: Validate PyPI user experience without SPEC_KITTY_TEMPLATE_ROOT bypass.
**Independent Test**: `pytest tests/adversarial/test_distribution.py -v -m distribution` passes.
**Prompt**: `/tasks/WP02-distribution-tests.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T008 Create `tests/adversarial/test_distribution.py` structure
- [ ] T009 Implement `test_wheel_build_and_install` (builds wheel, installs in venv)
- [ ] T010 Implement `test_init_without_template_root` (spec-kitty init)
- [ ] T011 Implement `test_research_feature_creation` (deliverables_path prompt)
- [ ] T012 Implement `test_upgrade_with_all_missions` (template propagation)
- [ ] T013 Create `wheel_install` fixture (session-scoped, builds wheel once)

### Implementation Notes
- Use `subprocess` for clean environment isolation
- Build wheel ONCE per session, reuse across tests
- Mark all tests with `@pytest.mark.distribution` and `@pytest.mark.slow`
- These tests are critical - they prevent another 0.10.8 catastrophe

### Parallel Opportunities
- T009-T012 can run in parallel after T008 and T013 fixture is ready

### Dependencies
- Depends on WP01 (shared fixtures)

### Risks & Mitigations
- Slow tests â†’ Run only on release branches in CI
- Wheel build flakiness â†’ Cache wheel between test runs

---

## Work Package WP03: Path Validation Security Tests (Priority: P1)

**Goal**: Test directory traversal, symlink, and path injection attack prevention.
**Independent Test**: `pytest tests/adversarial/test_path_validation.py -v` passes with all vectors rejected.
**Prompt**: `/tasks/WP03-path-validation-tests.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T014 Create `tests/adversarial/test_path_validation.py` structure
- [ ] T015 Implement `TestDirectoryTraversal` class (../../../, dot-slash)
- [ ] T016 Implement `TestCaseSensitivityBypass` class (macOS-specific)
- [ ] T017 Implement `TestEmptyPaths` class (empty, whitespace, slashes)
- [ ] T018 Implement `TestSymlinkAttacks` class (symlink to kitty-specs)
- [ ] T019 Implement `TestSpecialPaths` class (home, absolute, null byte)
- [ ] T020 Implement `TestUnicodePaths` class (valid unicode, RTL override)

### Implementation Notes
- Import `validate_deliverables_path` from `specify_cli.mission`
- Use parametrized tests with attack vectors from conftest
- Case-sensitivity tests should skip on case-sensitive filesystems
- Symlink tests should skip if symlinks not supported

### Parallel Opportunities
- T015-T020 are independent test classes, all can proceed in parallel

### Dependencies
- Depends on WP01 (PATH_ATTACK_VECTORS fixture)

### Risks & Mitigations
- Platform differences â†’ Use skipif decorators with clear messages

---

## Work Package WP04: CSV Schema Attack Tests (Priority: P1)

**Goal**: Test CSV injection, encoding, and malformed file handling.
**Independent Test**: `pytest tests/adversarial/test_csv_attacks.py -v` passes with graceful error handling.
**Prompt**: `/tasks/WP04-csv-attack-tests.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T021 Create `tests/adversarial/test_csv_attacks.py` structure
- [ ] T022 Implement `TestFormulaInjection` class (=, +, @, - prefixes)
- [ ] T023 Implement `TestEncodingAttacks` class (invalid UTF-8, BOM, Latin-1)
- [ ] T024 Implement `TestSchemaViolations` class (duplicates, missing, extra columns)
- [ ] T025 Implement `TestEmptyAndMalformed` class (empty, headers-only, mixed line endings)
- [ ] T026 Create `malformed_csv_factory` fixture helper

### Implementation Notes
- Import `validate_csv_schema` from `specify_cli.validators.csv_schema`
- Test files should be created in tmp_path, not in repo
- Validate error messages are user-friendly, not raw exceptions
- Formula injection tests verify no execution happens (Python csv module is safe)

### Parallel Opportunities
- T022-T025 are independent test classes

### Dependencies
- Depends on WP01 (CSV_ATTACK_VECTORS fixture)

### Risks & Mitigations
- Binary file handling â†’ Use write_bytes for encoding tests

---

## Work Package WP05: Git State Detection Tests (Priority: P2)

**Goal**: Test pre-review validation accuracy for edge-case git states.
**Independent Test**: `pytest tests/adversarial/test_git_state.py -v` passes with accurate detection.
**Prompt**: `/tasks/WP05-git-state-tests.md`
**Estimated Size**: ~500 lines

### Included Subtasks
- [ ] T027 Create `tests/adversarial/test_git_state.py` structure
- [ ] T028 Create git scenario fixtures (detached_head_repo, merge_state_repo)
- [ ] T029 Implement `TestDetachedHead` class (detection and error message)
- [ ] T030 Implement `TestMergeState` class (MERGE_HEAD, REBASE_HEAD, CHERRY_PICK_HEAD)
- [ ] T031 Implement `TestStagedUncommitted` class (clear distinction in messages)
- [ ] T032 Implement `TestMainDivergence` class (stale base detection)
- [ ] T033 Implement `TestNoCommitsOnBranch` class (empty WP branch)

### Implementation Notes
- Create real git repos with specific states in fixtures
- Import `_validate_ready_for_review` from tasks module (or test via CLI)
- Verify error messages provide actionable guidance
- Use existing git fixtures from root conftest as base

### Parallel Opportunities
- T029-T033 are independent test classes

### Dependencies
- Depends on WP01 (shared fixtures)

### Risks & Mitigations
- Git operations in tests can be slow â†’ Use shallow repos where possible

---

## Work Package WP06: Migration Robustness Tests (Priority: P2)

**Goal**: Test migration atomicity, concurrency, and error handling.
**Independent Test**: `pytest tests/adversarial/test_migration_robustness.py -v` passes.
**Prompt**: `/tasks/WP06-migration-robustness-tests.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T034 Create `tests/adversarial/test_migration_robustness.py` structure
- [ ] T035 Create migration test project fixture with .kittify structure
- [ ] T036 Implement `TestAtomicWrites` class (simulate interruption)
- [ ] T037 Implement `TestConcurrentMigration` class (multiprocessing race)
- [ ] T038 Implement `TestPartialMigrationRecovery` class (resume after failure)
- [ ] T039 Implement `TestPermissionErrors` class (read-only files)

### Implementation Notes
- Use `multiprocessing` for concurrent tests (not threading)
- Simulate interruption with signals or mock file operations
- Permission tests should restore permissions in cleanup
- Mark concurrent tests with `@pytest.mark.slow`

### Parallel Opportunities
- T036-T039 are independent test classes

### Dependencies
- Depends on WP01 (shared fixtures)

### Risks & Mitigations
- Concurrent tests can be flaky â†’ Use file locks, increase timeouts

---

## Work Package WP07: Multi-Parent Merge Tests (Priority: P2)

**Goal**: Test diamond dependency merge handling, determinism, and cleanup.
**Independent Test**: `pytest tests/adversarial/test_multi_parent_merge.py -v` passes.
**Prompt**: `/tasks/WP07-multi-parent-merge-tests.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T040 Create `tests/adversarial/test_multi_parent_merge.py` structure
- [ ] T041 Create diamond dependency fixture (WP01 â†’ WP02/WP03 â†’ WP04)
- [ ] T042 Implement `TestMergeConflictDetection` class (same file modified)
- [ ] T043 Implement `TestDeterministicMergeOrder` class (same tree hash)
- [ ] T044 Implement `TestOrphanedBranchCleanup` class (temporary branches removed)
- [ ] T045 Implement `TestThreeParentMerge` class (3+ dependencies)

### Implementation Notes
- Create repos with diamond dependency patterns
- Import `create_multi_parent_base` from `specify_cli.core.multi_parent_merge`
- Verify git tree hash is identical across multiple runs (determinism)
- Check for orphaned `*-merge-base` branches after cleanup

### Parallel Opportunities
- T042-T045 are independent test classes after fixture ready

### Dependencies
- Depends on WP01 (shared fixtures)

### Risks & Mitigations
- Complex git setup â†’ Document each scenario clearly in test docstrings

---

## Work Package WP08: Context & Config Tests (Priority: P3)

**Goal**: Test workspace context integrity, validation bypass prevention, and config resilience.
**Independent Test**: `pytest tests/adversarial/test_workspace_context.py tests/adversarial/test_context_validation.py tests/adversarial/test_agent_config.py -v` passes.
**Prompt**: `/tasks/WP08-context-config-tests.md`
**Estimated Size**: ~500 lines

### Included Subtasks
- [ ] T046 Create `tests/adversarial/test_workspace_context.py` structure
- [ ] T047 Implement `TestOrphanedContext` class (cleanup detection)
- [ ] T048 Implement `TestCorruptedContext` class (invalid JSON handling)
- [ ] T049 Create `tests/adversarial/test_context_validation.py` structure
- [ ] T050 Implement `TestEnvVarBypass` class (filesystem overrides env)
- [ ] T051 Implement `TestFalsePositiveWorktree` class (.worktrees dir naming)
- [ ] T052 Create `tests/adversarial/test_agent_config.py` structure
- [ ] T053 Implement `TestCorruptYaml` class (parse errors not silent fallback)
- [ ] T054 Implement `TestUnknownAgentKey` class (explicit error)

### Implementation Notes
- Test context using `specify_cli.workspace_context` module
- Test validation decorators from `specify_cli.core.context_validation`
- Test config using `specify_cli.upgrade.migrations` helpers
- Verify errors are explicit, not silent fallbacks

### Parallel Opportunities
- T046-T048, T049-T051, T052-T054 are three independent groups

### Dependencies
- Depends on WP01 (shared fixtures)

### Risks & Mitigations
- Many small test files â†’ Consider combining if total is manageable

---

## Dependency & Execution Summary

```
WP01 (Infrastructure) â”€â”€â”€â”€â”€â”¬â”€â”€â†’ WP02 (Distribution) ðŸŽ¯ MVP
                           â”œâ”€â”€â†’ WP03 (Path Validation)
                           â”œâ”€â”€â†’ WP04 (CSV Attacks)
                           â”œâ”€â”€â†’ WP05 (Git State)
                           â”œâ”€â”€â†’ WP06 (Migration)
                           â”œâ”€â”€â†’ WP07 (Multi-Parent)
                           â””â”€â”€â†’ WP08 (Context/Config)
```

- **Sequence**: WP01 first, then WP02-WP08 can proceed in parallel
- **Parallelization**: After WP01, all other WPs are independent
- **MVP Scope**: WP01 + WP02 constitute the minimal release (distribution tests are critical)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001-T007 | Test infrastructure setup | WP01 | P0 | T003-T006 |
| T008-T013 | Distribution tests | WP02 | P1 | T009-T012 |
| T014-T020 | Path validation tests | WP03 | P1 | T015-T020 |
| T021-T026 | CSV attack tests | WP04 | P1 | T022-T025 |
| T027-T033 | Git state tests | WP05 | P2 | T029-T033 |
| T034-T039 | Migration robustness tests | WP06 | P2 | T036-T039 |
| T040-T045 | Multi-parent merge tests | WP07 | P2 | T042-T045 |
| T046-T054 | Context/config tests | WP08 | P3 | Groups of 3 |

**Total**: 54 subtasks across 8 work packages (avg 6.75 per WP)
