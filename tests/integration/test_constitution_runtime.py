"""Integration tests for constitution runtime behavior.

Tests the constitution system's runtime behavior including:
- Constitution discovery in main repo and package
- Loading and validation
- Graceful fallback when missing
- Migration creates valid files
"""

from __future__ import annotations

import subprocess
from pathlib import Path

import pytest


class TestConstitutionDiscovery:
    """Tests for constitution file discovery."""

    def test_discover_constitution_in_main_repo(self, tmp_path: Path):
        """Test discovering constitution file in main repository."""
        # Create main repo with constitution
        repo = tmp_path / "repo"
        repo.mkdir()

        # Initialize git
        subprocess.run(["git", "init"], cwd=repo, check=True, capture_output=True)
        subprocess.run(
            ["git", "config", "user.name", "Test"],
            cwd=repo,
            check=True,
            capture_output=True,
        )
        subprocess.run(
            ["git", "config", "user.email", "test@example.com"],
            cwd=repo,
            check=True,
            capture_output=True,
        )

        # Create .kittify structure
        kittify_dir = repo / ".kittify"
        memory_dir = kittify_dir / "memory"
        memory_dir.mkdir(parents=True)

        # Create constitution file
        constitution_file = memory_dir / "constitution.md"
        constitution_content = """# Project Constitution

> Auto-generated by spec-kitty constitution command
> Created: 2026-01-23
> Version: 1.0.0

## Purpose

This constitution captures the technical standards for the project.

## Technical Standards

### Languages and Frameworks
Python 3.11+ with pytest for testing

### Testing Requirements
pytest with 80% line coverage required

### Performance and Scale
CLI operations should complete in < 2 seconds

### Deployment and Constraints
Cross-platform: Linux, macOS, Windows 10+

## Governance

### Amendment Process
Any team member can propose amendments via pull request.

### Compliance Validation
Code reviewers validate compliance during PR review.
"""
        constitution_file.write_text(constitution_content, encoding="utf-8")

        # Verify file exists and can be read
        assert constitution_file.exists()
        content = constitution_file.read_text(encoding="utf-8")
        assert "Project Constitution" in content
        assert "Technical Standards" in content
        assert "Python 3.11+" in content

    def test_discover_constitution_in_package(self, tmp_path: Path):
        """Test discovering constitution template in package resources."""
        # Create package-like structure
        package_dir = tmp_path / "package"
        package_dir.mkdir()

        # Simulate package structure
        templates_dir = package_dir / "templates" / "command-templates"
        templates_dir.mkdir(parents=True)

        # Constitution command template should exist
        constitution_template = templates_dir / "constitution.md"
        constitution_template.write_text(
            """---
description: Create or update the project constitution
---

## What This Command Does

This command creates or updates the project constitution.
""",
            encoding="utf-8",
        )

        # Verify template exists
        assert constitution_template.exists()
        content = constitution_template.read_text(encoding="utf-8")
        assert "project constitution" in content.lower()

    def test_constitution_loads_correctly(self, tmp_path: Path):
        """Test that constitution file loads with correct structure."""
        # Create constitution
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        constitution_file = memory_dir / "constitution.md"
        constitution_content = """# Test Project Constitution

> Version: 1.0.0

## Technical Standards

### Languages and Frameworks
TypeScript 4.9+ with React 18

### Testing Requirements
Jest with 90% coverage

## Governance

### Amendment Process
Standard PR process
"""
        constitution_file.write_text(constitution_content, encoding="utf-8")

        # Load and validate structure
        content = constitution_file.read_text(encoding="utf-8")

        # Verify required sections
        assert "# Test Project Constitution" in content
        assert "## Technical Standards" in content
        assert "### Languages and Frameworks" in content
        assert "### Testing Requirements" in content
        assert "## Governance" in content
        assert "### Amendment Process" in content

        # Verify content
        assert "TypeScript 4.9+" in content
        assert "Jest with 90% coverage" in content

    def test_constitution_validation_passes(self, tmp_path: Path):
        """Test that valid constitution passes validation checks."""
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        constitution_file = memory_dir / "constitution.md"
        constitution_content = """# Valid Constitution

> Version: 1.0.0

## Technical Standards

### Languages and Frameworks
Rust 1.70+ with no external dependencies

### Testing Requirements
cargo test, all features must have tests

### Performance and Scale
Handle 1000 requests/second at p95 < 200ms

### Deployment and Constraints
Docker-only, deployed to Kubernetes

## Code Quality

### Pull Request Requirements
2 approvals required, 1 must be from core team

### Quality Gates
All tests pass, coverage ≥80%, linter clean

## Governance

### Amendment Process
PR with 2 approvals, announce in team chat

### Compliance Validation
Code reviewers check compliance
"""
        constitution_file.write_text(constitution_content, encoding="utf-8")

        # Validate structure
        content = constitution_file.read_text(encoding="utf-8")

        # Check all required sections present
        required_sections = [
            "# Valid Constitution",
            "## Technical Standards",
            "### Languages and Frameworks",
            "### Testing Requirements",
            "### Performance and Scale",
            "### Deployment and Constraints",
            "## Governance",
            "### Amendment Process",
            "### Compliance Validation",
        ]

        for section in required_sections:
            assert section in content, f"Missing required section: {section}"


class TestConstitutionGracefulFallback:
    """Tests for graceful fallback when constitution is missing."""

    def test_runs_without_constitution(self, tmp_path: Path):
        """Test that spec-kitty commands run without constitution file."""
        # Create minimal project structure (no constitution)
        kittify_dir = tmp_path / ".kittify"
        kittify_dir.mkdir()

        memory_dir = kittify_dir / "memory"
        memory_dir.mkdir()

        # No constitution.md file

        # Verify directory structure works without constitution
        assert kittify_dir.exists()
        assert memory_dir.exists()
        assert not (memory_dir / "constitution.md").exists()

        # Create a minimal config file
        config_file = kittify_dir / "config.yaml"
        config_file.write_text("version: '0.12.0'\n", encoding="utf-8")

        assert config_file.exists()

    def test_warns_when_constitution_missing(self, tmp_path: Path):
        """Test that missing constitution is handled gracefully (no errors)."""
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        # No constitution file
        constitution_path = memory_dir / "constitution.md"

        # Check file doesn't exist
        assert not constitution_path.exists()

        # This should not raise an error - commands should work without it
        # (In real code, commands check if file exists before reading)
        if constitution_path.exists():
            content = constitution_path.read_text(encoding="utf-8")
        else:
            content = None

        assert content is None

    def test_uses_default_templates_without_constitution(self, tmp_path: Path):
        """Test that default templates are used when constitution is missing."""
        # Create project without constitution
        kittify_dir = tmp_path / ".kittify"
        templates_dir = kittify_dir / "templates"
        templates_dir.mkdir(parents=True)

        # Create a basic template (plan template references constitution optionally)
        plan_template = templates_dir / "plan-template.md"
        plan_template_content = """# Implementation Plan

Load context: Read FEATURE_SPEC and `.kittify/memory/constitution.md` if it exists.
If the constitution file is missing, skip Constitution Check and note that it is absent.

## Plan Structure

... rest of template ...
"""
        plan_template.write_text(plan_template_content, encoding="utf-8")

        # Verify template exists
        assert plan_template.exists()
        content = plan_template.read_text(encoding="utf-8")
        assert "if it exists" in content
        assert "If the constitution file is missing" in content

    def test_constitution_migration_creates_valid_files(self, tmp_path: Path):
        """Test that migration/init creates valid constitution files."""
        # Simulate constitution creation during init
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        # Create minimal placeholder (skip scenario)
        constitution_file = memory_dir / "constitution.md"
        placeholder_content = """# Project Constitution

Constitution skipped - not required for spec-kitty usage.

Run `/spec-kitty.constitution` anytime to create a full constitution.
"""
        constitution_file.write_text(placeholder_content, encoding="utf-8")

        # Verify placeholder is valid
        assert constitution_file.exists()
        content = constitution_file.read_text(encoding="utf-8")
        assert "Constitution skipped" in content
        assert "/spec-kitty.constitution" in content

    def test_constitution_minimal_creation(self, tmp_path: Path):
        """Test creating minimal constitution with Phase 1 only."""
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        constitution_file = memory_dir / "constitution.md"
        minimal_content = """# My Project Constitution

> Auto-generated by spec-kitty constitution command
> Created: 2026-01-23
> Version: 1.0.0

## Purpose

This constitution captures the technical standards for My Project.

## Technical Standards

### Languages and Frameworks
Python 3.11+ with FastAPI for backend

### Testing Requirements
pytest with 80% line coverage, 100% for critical paths

### Performance and Scale
Handle 1000 requests/second at p95 < 200ms

### Deployment and Constraints
Docker-only, deployed to Kubernetes

## Governance

### Amendment Process
Any team member can propose amendments via pull request. Changes are discussed
and merged following standard PR review process.

### Compliance Validation
Code reviewers validate compliance during PR review. Constitution violations
should be flagged and addressed before merge.

### Exception Handling
Exceptions discussed case-by-case with team. Strong justification required.
Consider updating constitution if exceptions become common.
"""
        constitution_file.write_text(minimal_content, encoding="utf-8")

        # Verify minimal constitution is valid
        content = constitution_file.read_text(encoding="utf-8")
        assert "## Technical Standards" in content
        assert "## Governance" in content
        # Should not have optional sections
        assert "## Code Quality" not in content
        assert "## Tribal Knowledge" not in content

    def test_constitution_comprehensive_creation(self, tmp_path: Path):
        """Test creating comprehensive constitution with all phases."""
        memory_dir = tmp_path / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        constitution_file = memory_dir / "constitution.md"
        comprehensive_content = """# Enterprise Project Constitution

> Auto-generated by spec-kitty constitution command
> Created: 2026-01-23
> Version: 1.0.0

## Purpose

This constitution captures the technical standards, code quality expectations,
tribal knowledge, and governance rules for Enterprise Project.

## Technical Standards

### Languages and Frameworks
Java 17+ with Spring Boot 3.0

### Testing Requirements
JUnit 5 with 85% coverage, integration tests required

### Performance and Scale
Support 10k concurrent users, 1M daily active users

### Deployment and Constraints
Kubernetes on AWS EKS, multi-region deployment

## Code Quality

### Pull Request Requirements
2 approvals required, 1 must be from core team

### Code Review Checklist
Tests added, documentation updated, security scan clean, no performance regressions

### Quality Gates
All tests pass, coverage ≥85%, SonarQube quality gate passed, security scan clean

### Documentation Standards
All public APIs must have Javadoc + examples, ADRs for architectural decisions

## Tribal Knowledge

### Team Conventions
Use Optional<T> for nullable values, never return null from public APIs

### Lessons Learned
Always version APIs from day 1, write integration tests first

### Historical Decisions
Chose microservices for independent scaling, chose Kafka for event streaming

## Governance

### Amendment Process
PR with 2 approvals, announce in team chat, 1 week discussion period

### Compliance Validation
Code reviewers check compliance, architecture review board validates architectural decisions

### Exception Handling
Document in ADR, require 3 approvals, set sunset date for temporary exceptions
"""
        constitution_file.write_text(comprehensive_content, encoding="utf-8")

        # Verify comprehensive constitution has all sections
        content = constitution_file.read_text(encoding="utf-8")
        assert "## Technical Standards" in content
        assert "## Code Quality" in content
        assert "## Tribal Knowledge" in content
        assert "## Governance" in content

        # Verify all subsections
        assert "### Languages and Frameworks" in content
        assert "### Pull Request Requirements" in content
        assert "### Team Conventions" in content
        assert "### Amendment Process" in content

    def test_constitution_accessible_from_worktree(self, tmp_path: Path):
        """Test that constitution is accessible from worktree context."""
        # Create main repo with constitution
        repo = tmp_path / "repo"
        repo.mkdir()

        subprocess.run(["git", "init"], cwd=repo, check=True, capture_output=True)
        subprocess.run(
            ["git", "config", "user.name", "Test"],
            cwd=repo,
            check=True,
            capture_output=True,
        )
        subprocess.run(
            ["git", "config", "user.email", "test@example.com"],
            cwd=repo,
            check=True,
            capture_output=True,
        )

        # Create constitution in main repo
        memory_dir = repo / ".kittify" / "memory"
        memory_dir.mkdir(parents=True)

        constitution_file = memory_dir / "constitution.md"
        constitution_file.write_text("# Main Constitution\n\nTest content", encoding="utf-8")

        # Create initial commit
        (repo / "README.md").write_text("test")
        subprocess.run(["git", "add", "."], cwd=repo, check=True, capture_output=True)
        subprocess.run(
            ["git", "commit", "-m", "init"],
            cwd=repo,
            check=True,
            capture_output=True,
        )

        # Create worktree
        worktree_dir = repo / ".worktrees" / "feature-WP01"
        subprocess.run(
            ["git", "worktree", "add", str(worktree_dir), "-b", "feature-WP01"],
            cwd=repo,
            check=True,
            capture_output=True,
        )

        # Constitution should be accessible from main repo
        # (Worktrees reference main repo's .kittify via relative path)
        assert constitution_file.exists()

        # In real usage, commands running in worktree would reference
        # main repo's constitution via path resolution
        content = constitution_file.read_text(encoding="utf-8")
        assert "Main Constitution" in content
